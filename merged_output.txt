================== BEGIN FILE ==================
File: ./.syncrclone/backups/2025-10-27T111316_nixos-sync_A/modules/nixos/2-workspace/default.nix
Extension: .nix
================================================

{
  imports = [
    ./display-manager.nix
    ./window-managers.nix
  ];
}

=================== END FILE ===================
File: ./.syncrclone/backups/2025-10-27T111316_nixos-sync_A/modules/nixos/2-workspace/default.nix
================================================


================== BEGIN FILE ==================
File: ./flake.nix
Extension: .nix
================================================

{
  description = "NixOS";

  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";
    chaotic.url = "github:chaotic-cx/nyx/nyxpkgs-unstable";
    nix-colors.url = "github:misterio77/nix-colors";
    mango.url = "github:DreamMaoMao/mango";
    nix-vscode-extensions.url = "github:nix-community/nix-vscode-extensions";
    
    claude-desktop = {
      url = "github:k3d3/claude-desktop-linux-flake";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    home-manager = {
      url = "github:nix-community/home-manager";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    disko = {
      url = "github:nix-community/disko";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    minimalFox = {
      url = "github:Jamir-boop/minimalisticfox";
      flake = false;
    };

    zen-browser = {
      url = "github:0xc000022070/zen-browser-flake";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs =
    { nixpkgs, home-manager, ... }@inputs:
    let
      system = "x86_64-linux";
      lib = nixpkgs.lib;
      pkgs = nixpkgs.legacyPackages.${system};

      hostsWithHm = [
        "desktop"
        "laptop"
      ];
      hosts = hostsWithHm ++ [ "server" ];

      wallpapers = import ./shared/wallpapers.nix;

      mkCommonArgs =
        hostname:
        let
          conf = import ./shared/config.nix { inherit lib hostname; };
        in
        {
          inherit
            inputs
            wallpapers
            conf
            system
            ;
          helpers = import ./shared/helpers.nix { inherit lib conf; };
        };

      getModules =
        type:
        let
          moduleMap = {
            nixos = [
              inputs.disko.nixosModules.disko
              inputs.chaotic.nixosModules.default
              inputs.mango.nixosModules.mango
              { nixpkgs.config.allowUnfree = true; }
              ./modules/nixos
            ];

            home = [
              inputs.mango.hmModules.mango
              inputs.nix-colors.homeManagerModules.default
              { colorScheme = inputs.nix-colors.colorSchemes.ayu-dark; }
              ./modules/home-manager
            ];
          };
        in
        moduleMap.${type};

      mkHomeManagerModule = hostname: commonArgs: {
        home-manager = {
          useGlobalPkgs = true;
          useUserPackages = true;
          backupFileExtension = "HM";
          extraSpecialArgs = commonArgs;

          users.${commonArgs.conf.username} = {
            imports = (getModules "home") ++ [
              ./hosts/${hostname}/home.nix
            ];

            home.activation.cleanupBackups = home-manager.lib.hm.dag.entryBefore ["checkLinkTargets"] ''
              run find $HOME/.config -maxdepth 2 -name "*.HM" -type f -delete 2>/dev/null || true
            '';
          };
        };
      };

      mkNixosSystem =
        hostname:
        let
          commonArgs = mkCommonArgs hostname;
        in
        lib.nixosSystem {
          inherit system;
          specialArgs = commonArgs;
          modules =
            (getModules "nixos")
            ++ [
              ./hosts/${hostname}/configuration.nix
            ]
            ++ lib.optionals (builtins.elem hostname hostsWithHm) [
              home-manager.nixosModules.home-manager
              (mkHomeManagerModule hostname commonArgs)
            ];
        };
    in
    {
      nixosConfigurations = lib.genAttrs hosts mkNixosSystem;

      devShells.${system} = {
        python = import ./devshells/python.nix { inherit pkgs; };
        csharp = import ./devshells/csharp.nix { inherit pkgs; };
      };
    };
}

=================== END FILE ===================
File: ./flake.nix
================================================


================== BEGIN FILE ==================
File: ./devshells/python.nix
Extension: .nix
================================================

{ pkgs }:

pkgs.mkShell {
  name = "python-dev";
  
  nativeBuildInputs = with pkgs; [
    pkg-config
    qt6.wrapQtAppsHook
  ];
  
  buildInputs = with pkgs; [
    qt6.qtbase
    qt6.qtdeclarative
    qt6.qtwayland
    
    gtk3
    gtk4
    gobject-introspection
    
    wayland
    libxkbcommon
    xorg.libX11
    xorg.libxcb
    
    libGL
    mesa
    
    (python3.withPackages (ps: with ps; [
      pyside6
      pyqt6
      tkinter
      pygobject3
      numpy
      pandas
      matplotlib
      scipy
      openai
      requests
      pip
      setuptools
      wheel
      pytest
      black
      pylint
      ipython
    ]))
  ];

  shellHook = ''
    export QT_QPA_PLATFORM="xcb"
    export QT_PLUGIN_PATH="${pkgs.qt6.qtbase}/lib/qt-6/plugins"
    
    export DISPLAY="''${DISPLAY:-:0}"
    export WAYLAND_DISPLAY="''${WAYLAND_DISPLAY:-wayland-1}"
    
    export GDK_BACKEND=x11
    export XDG_DATA_DIRS="$XDG_DATA_DIRS:${pkgs.gtk3}/share"
    
    echo "Python Dev Environment"
  '';
}

=================== END FILE ===================
File: ./devshells/python.nix
================================================


================== BEGIN FILE ==================
File: ./devshells/csharp.nix
Extension: .nix
================================================

{ pkgs }:

pkgs.mkShell {
  name = "csharp-dev";
  
  nativeBuildInputs = with pkgs; [
    pkg-config
  ];
  
  buildInputs = with pkgs; [
    # .NET SDK
    dotnet-sdk_9
    
    # GUI –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    gtk3
    gtk4
    
    # Avalonia UI –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    fontconfig
    libX11
    libICE
    libSM
    
    # Wayland/X11 –ø–æ–¥–¥–µ—Ä–∂–∫–∞
    wayland
    xorg.libX11
    xorg.libXrandr
    xorg.libXcursor
    xorg.libXi
    
    # OpenGL –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    libGL
    
    # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    omnisharp-roslyn
    netcoredbg
  ];

  shellHook = ''
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .NET
    export DOTNET_ROOT="${pkgs.dotnet-sdk_9}"
    export DOTNET_CLI_TELEMETRY_OPTOUT=1
    export DOTNET_SKIP_FIRST_TIME_EXPERIENCE=1
    
    # GUI –ø–æ–¥–¥–µ—Ä–∂–∫–∞
    export GDK_BACKEND=wayland,x11
    export WAYLAND_DISPLAY="''${WAYLAND_DISPLAY:-wayland-0}"
    export DISPLAY="''${DISPLAY:-:0}"
    
    # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    export XDG_DATA_DIRS="$XDG_DATA_DIRS:${pkgs.gtk3}/share:${pkgs.gsettings-desktop-schemas}/share"
    export LD_LIBRARY_PATH="${pkgs.fontconfig.lib}/lib:${pkgs.libGL}/lib:$LD_LIBRARY_PATH"
    
    echo "# C# Dev Environment"
  '';
}

=================== END FILE ===================
File: ./devshells/csharp.nix
================================================


================== BEGIN FILE ==================
File: ./shared/helpers.nix
Extension: .nix
================================================

{ lib, conf }:
let
  waylandCompositors = [
    "hyprland"
    "niri"
    "dwl"
    "mangowc"
  ];
  x11WMs = [
    "bspwm"
    "dwm"
  ];
  wlrCompositors = [
    "sway"
    "dwl"
    "mangowc"
  ];

  hasIn =
    category: feature:
    let
      categoryList = conf.${category}.enable or [ ];
      checkList = features: lib.any (f: lib.elem f categoryList) features;
      checkSingle = f: lib.elem f categoryList;
    in
    lib.isList categoryList && (if lib.isList feature then checkList feature else checkSingle feature);
in
{
  isLaptop = conf.machineType == "laptop";
  isDesktop = conf.machineType == "desktop";
  isServer = conf.machineType == "server";

  isWayland = hasIn "workspace" waylandCompositors;
  isX11 = hasIn "workspace" x11WMs;
  isWM = hasIn "workspace" (waylandCompositors ++ x11WMs);

  isHyprland = hasIn "workspace" "hyprland";
  isWlr = hasIn "workspace" wlrCompositors;
  isNiri = hasIn "workspace" "niri";
  isDwl = hasIn "workspace" "dwl";
  isMango = hasIn "workspace" "mangowc";

  needsHyprlandPortal = hasIn "workspace" "hyprland";
  needsWlrPortal = hasIn "workspace" wlrCompositors;

  hasNvidia = hasIn "hardware" "nvidia";
  hasIntel = hasIn "hardware" "intel";
  hasAMD = hasIn "hardware" "amd";

  inherit hasIn;
}

=================== END FILE ===================
File: ./shared/helpers.nix
================================================


================== BEGIN FILE ==================
File: ./shared/config.nix
Extension: .nix
================================================

{ lib, hostname }:
let
  machineType = hostname;

  commonVars = {
    hostname = "nixos";
    inherit machineType;

    username = "user";

    colorScheme = "dark";
    wallpaperName = "backyard";

    default = {
      terminal = "foot";
      editor = "nvim";
      visual = "code";
      browser = "zen";
    };
  };

  desktopVars = lib.recursiveUpdate commonVars {
    base = {
      enable = [
        "boot"
        "system"
        "security"
        "locale"
        "network"
        "users"
        "fonts"
      ];
    };
    hardware = {
      enable = [
        "sound"
        "keyboard-mouse"
        "intel"
        "nvidia"
        "power"
        "print"
      ];
    };
    workspace = {
      enable = [
        "hyprland"
        "wallpapers"
        "themes"
      ];
    };
    programs = {
      enable = [
        "appimage"
        "nix-lang"
        "python-lang"
        "dotnet"
        "nodejs"
        "gaming"
      ];
    };
    services = {
      enable = [
        "sing-box"
        "openssh"
        "gammastep"
        "virtual-machine"
        "print"
      ];
    };
  };

  laptopVars = lib.recursiveUpdate commonVars {
    base = {
      enable = [
        "boot"
        "system"
        "security"
        "locale"
        "network"
        "users"
        "fonts"
      ];
    };
    hardware = {
      enable = [
        "keyboard-mouse"
        "amd"
        "power"
      ];
    };
    workspace = {
      enable = [
        "hyprland"
        "wallpapers"
        "themes"
      ];
    };
    programs = {
      enable = [
        "nix-lang"
        "python-lang"
        "dotnet"
        "nodejs"
      ];
    };
    services = {
      enable = [
        "sing-box"
        "openssh"
        "brightnessctl"
      ];
    };
  };

  serverVars = lib.recursiveUpdate commonVars {
    base = {
      enable = [
        "boot"
        "system"
        "security"
        "locale"
        "network"
        "users"
      ];
    };
    hardware = {
      enable = [ ];
    };
    workspace = {
      enable = [ ];
    };
    programs = {
      enable = [ ];
    };
    services = {
      enable = [
        "cassettes-site"
        "openssh"
        "xray"
        "fail2ban"
      ];
    };
  };
in
if machineType == "laptop" then
  laptopVars
else if machineType == "server" then
  serverVars
else if machineType == "desktop" then
  desktopVars
else
  throw "Unknown hostname: ${hostname}. Expected: desktop, laptop, or server"

=================== END FILE ===================
File: ./shared/config.nix
================================================


================== BEGIN FILE ==================
File: ./shared/wallpapers.nix
Extension: .nix
================================================

{
  backyard = ./wallpapers/Backyard.png;
  lanscape = ./wallpapers/Fantasy-Lanscape-Night.png;
}

=================== END FILE ===================
File: ./shared/wallpapers.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/base/environment.nix
Extension: .nix
================================================

{
  conf,
  pkgs,
  ...
}:
{
  config = {
    home.sessionPath = [
      "$HOME/.local/bin"
    ];

    home.sessionVariables = {
      DOTS = "$HOME/nixos";
      TERMINAL = conf.default.terminal;
      EDITOR = conf.default.editor;
      VISUAL = conf.default.visual;
      BROWSER = conf.default.browser;
      XDG_DATA_DIRS = "$XDG_DATA_DIRS:${pkgs.gsettings-desktop-schemas}/share/gsettings-schemas/${pkgs.gsettings-desktop-schemas.name}:${pkgs.gtk3}/share/gsettings-schemas/${pkgs.gtk3.name}";
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/base/environment.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/base/packages.nix
Extension: .nix
================================================

{
  pkgs,
  ...
}:
{
  home.packages = with pkgs; [
    bat
    lsd
    btop
    wl-clipboard
    inxi
    tree
    exfatprogs
    libva-utils
    ffmpeg
    ffmpegthumbnailer
    gftp

    glib
    gsettings-desktop-schemas
    gtk3
    dconf

    arj
    lha
    lrzip
    lzop
    p7zip
    pbzip2
    pigz
    pixz
    unrar
    unzip
    zip
    brotli
    cpio
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/base/packages.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/base/default.nix
Extension: .nix
================================================

{
  imports = [
    ./environment.nix
    ./packages.nix
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/base/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/services/default.nix
Extension: .nix
================================================

{
  imports = [
    ./gammastep.nix
    ./brightness.nix
    ./kanshi.nix
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/services/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/services/gammastep.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "gammastep";
in
{
  config = lib.mkIf enable {
    services.gammastep = {
      enable = true;
      package = pkgs.gammastep;

      latitude = 43.1155;
      longitude = 131.8855;

      temperature = {
        day = 6000;
        night = 3200;
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/services/gammastep.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/services/brightness.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "brightnessctl";
in
{
  config = lib.mkIf enable {
    home.packages = [ pkgs.brightnessctl ];

    systemd.user.services.brightness = {
      Unit = {
        Description = "Set brightness on startup";
        After = [ "graphical-session.target" ];
      };

      Install = {
        WantedBy = [ "graphical-session.target" ];
      };

      Service = {
        Type = "oneshot";
        ExecStart = "${pkgs.brightnessctl}/bin/brightnessctl set 50%";
        RemainAfterExit = true;
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/services/brightness.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/services/kanshi.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  ...
}:
{
  config = lib.mkIf (helpers.isWM && helpers.isWayland) {
    services.kanshi = {
      enable = true;
      systemdTarget = "graphical-session.target";

      settings = [
        {
          profile.name = "desktop";
          profile.outputs = [
            {
              criteria = "DP-3";
              mode = "2560x1440@165Hz";
              position = "0,0";
              scale = 1.0;
            }
            {
              criteria = "DP-4";
              mode = "1920x1080@100Hz";
              transform = "270";
              position = "2560,0";
              scale = 1.0;
            }
            {
              criteria = "HDMI-A-5";
              mode = "1920x1080@60Hz";
              position = "640,1440";
              scale = 1.0;
            }
          ];
        }
        {
          profile.name = "laptop";
          profile.outputs = [
            {
              criteria = "eDP-1";
              mode = "2560x1440@48Hz";
              position = "0,0";
              scale = 1.0;
            }
          ];
        }
      ];
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/services/kanshi.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/packages.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  helpers,
  inputs,
  ...
}:
{
  home.packages =
    with pkgs;
    [
      qimgv
      czkawka-full
      mullvad-browser
      tor-browser
      telegram-desktop
      libreoffice-fresh
      xlsclients
      xarchiver
      transmission_4-gtk
      nemo
      xmind
      (termius.overrideAttrs (oldAttrs: {
        buildInputs = (oldAttrs.buildInputs or [ ]) ++ [ sqlite ];
      }))
      vial
      drawio
      discord
      claude-code
      brave
      wev
      inputs.claude-desktop.packages.${pkgs.system}.claude-desktop-with-fhs
      insomnia
      kooha
      #jetbrains.rider
    ]
    ++ lib.optionals (helpers.hasIn "hardware" "sound") [
      pavucontrol
      easyeffects
    ]
    ++ lib.optionals (helpers.hasIn "hardware" "print") [
      simple-scan
      sane-frontends
    ]
    ++ lib.optionals (helpers.hasIn "services" "virtual-machine") [
      virt-manager
    ];
}

=================== END FILE ===================
File: ./modules/home-manager/programs/packages.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/applications/rclone.nix
Extension: .nix
================================================

{ config, pkgs, ... }:
let
  knastuConfig = ''
    ## Remotes:
    remoteA = "${config.home.homeDirectory}/knastu"
    remoteB = "cloud:sync/knastu"

    workdirA = None
    workdirB = None

    name = "knastu-sync"

    ## rclone flags
    rclone_exe = "rclone"

    filter_flags = [
      '--exclude', '*.tmp',
      '--exclude', '*.temp',
      '--exclude', '*.cache',
      '--exclude', '*.log',
      '--exclude', '.git/**',
      '--exclude', '.git',
      '--exclude', 'node_modules/**',
      '--exclude', '__pycache__/**',
      '--exclude', '*.pyc',
      '--exclude', '.DS_Store',
      '--exclude', 'Thumbs.db',
      '--exclude', '~$*',
      '--exclude', '.~lock.*',
      '--exclude', '*.swp',
      '--exclude', '*.swo',
      '--exclude', '.syncrclone/**',
    ]

    rclone_flags = []

    rclone_env = {}

    rclone_flagsA = []
    rclone_flagsB = []

    ## Sync Options
    compare = "mtime"

    dt = 1.1

    conflict_mode = "newer"
    tag_conflict = False

    reuse_hashesA = False
    reuse_hashesB = False

    always_get_mtime = True

    backup = True
    backup_with_copy = None

    sync_backups = False

    hash_fail_fallback = "mtime"

    set_lock = True

    action_threads = 4

    cleanup_empty_dirsA = None
    cleanup_empty_dirsB = None

    avoid_relist = True

    ## Rename Tracking
    renamesA = "hash"
    renamesB = "hash"

    ## Status
    list_status_dt = 10

    ## Logs
    save_logs = True
    local_log_dest = ""  # NOT on a remote

    pre_sync_shell = ""
    post_sync_shell = ""

    stop_on_shell_error = False

    tempdir = None

    ## Version
    _syncrclone_version = "20230310.0.BETA"
  '';

  nixosConfig = ''
     ## Remotes:
    remoteA = "${config.home.homeDirectory}/nixos"
    remoteB = "cloud:sync/nixos"

    workdirA = None
    workdirB = None

    name = "nixos-sync"

    ## rclone flags
    rclone_exe = "rclone"

    filter_flags = [
      '--exclude', '*.tmp',
      '--exclude', '*.temp',
      '--exclude', '*.cache',
      '--exclude', '*.log',
      '--exclude', '.git/**',
      '--exclude', '.git',
      '--exclude', 'node_modules/**',
      '--exclude', '__pycache__/**',
      '--exclude', '*.pyc',
      '--exclude', '.DS_Store',
      '--exclude', 'Thumbs.db',
      '--exclude', '~$*',
      '--exclude', '.~lock.*',
      '--exclude', '*.swp',
      '--exclude', '*.swo',
      '--exclude', '.syncrclone/**',
    ]

    rclone_flags = []

    rclone_env = {}

    rclone_flagsA = []
    rclone_flagsB = []

    ## Sync Options
    compare = "mtime"

    dt = 1.1

    conflict_mode = "newer"
    tag_conflict = False

    reuse_hashesA = False
    reuse_hashesB = False

    always_get_mtime = True

    backup = True
    backup_with_copy = None

    sync_backups = False

    hash_fail_fallback = "mtime"

    set_lock = True

    action_threads = 4

    cleanup_empty_dirsA = None
    cleanup_empty_dirsB = None

    avoid_relist = True

    ## Rename Tracking
    renamesA = "hash"
    renamesB = "hash"

    ## Status
    list_status_dt = 10

    ## Logs
    save_logs = True
    local_log_dest = ""  # NOT on a remote

    pre_sync_shell = ""
    post_sync_shell = ""

    stop_on_shell_error = False

    tempdir = None

    ## Version
    _syncrclone_version = "20230310.0.BETA"
  '';
in
{
  home.packages = [
    pkgs.rclone
    pkgs.rclone-browser
    pkgs.syncrclone
  ];

  home.file = {
    ".syncrclone/knastu.py".text = knastuConfig;
    ".syncrclone/nixos.py".text = nixosConfig;
  };

  home.file.".local/bin/sync-folders" = {
    executable = true;
    text = ''
      #!${pkgs.bash}/bin/bash
      set -e

      echo "=== Syncing knastu ==="
      ${pkgs.syncrclone}/bin/syncrclone ${config.home.homeDirectory}/.syncrclone/knastu.py

      echo "=== Syncing nixos ==="
      ${pkgs.syncrclone}/bin/syncrclone ${config.home.homeDirectory}/.syncrclone/nixos.py

      echo "=== Sync completed ==="
    '';
  };
}

=================== END FILE ===================
File: ./modules/home-manager/programs/applications/rclone.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/applications/firefox.nix
Extension: .nix
================================================

{
  pkgs,
  inputs,
  ...
}:
{
  home.packages = [
    pkgs.cascadia-code
  ];

  programs.firefox = {
    enable = true;
    package = pkgs.firefox-esr;

    profiles.default = {
      id = 0;
      name = "default";
      isDefault = true;

      userChrome = builtins.concatStringsSep "\n" [
        (builtins.readFile "${inputs.minimalFox}/userChrome.css")
        ''
          #nav-bar {
            top: 0 !important;
            margin-top: 8px !important;
          }
        ''
      ];

      settings = {
        "toolkit.legacyUserProfileCustomizations.stylesheets" = true;
        "browser.compactmode.show" = true;
        "browser.uidensity" = 1;

        "font.name.monospace.x-western" = "Cascadia Code";
        "font.name.sans-serif.x-western" = "Cascadia Code";
        "font.name.serif.x-western" = "Cascadia Code";
        "font.size.monospace.x-western" = 12;

        "browser.tabs.tabmanager.enabled" = false;
        "browser.tabs.hoverPreview" = false;
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/programs/applications/firefox.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/applications/obs.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  helpers,
  ...
}:
{
  config = lib.mkMerge [
    {
      programs.obs-studio = {
        enable = true;

        plugins = with pkgs.obs-studio-plugins; [
          obs-pipewire-audio-capture
          obs-gstreamer
          obs-websocket
          obs-move-transition
          obs-backgroundremoval
          obs-shaderfilter
          obs-vkcapture
          obs-source-record
          obs-vertical-canvas
          input-overlay
          advanced-scene-switcher
        ];
      };
    }

    (lib.mkIf helpers.isWayland {
      programs.obs-studio.plugins = with pkgs.obs-studio-plugins; [
        wlrobs
      ];
    })

    (lib.mkIf helpers.hasNvidia {
      programs.obs-studio = {
        package = pkgs.obs-studio.override {
          cudaSupport = true;
        };
      };
    })

    (lib.mkIf (!helpers.hasNvidia) {
      programs.obs-studio.plugins = with pkgs.obs-studio-plugins; [
        obs-vaapi
      ];
    })
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/programs/applications/obs.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/applications/zen-browser.nix
Extension: .nix
================================================

{
  config,
  pkgs,
  inputs,
  wallpapers,
  conf,
  ...
}:
let
  colors = config.colorScheme.palette;
  wallpaper = wallpapers.${conf.wallpaperName} or wallpapers.backyard;
in
{
  config = {
    home.packages = [
      pkgs.pywalfox-native
      inputs.zen-browser.packages.${pkgs.system}.default
    ];

    home.file.".zen/native-messaging-hosts/pywalfox.json".text = builtins.toJSON {
      name = "pywalfox";
      description = "Pywalfox native messaging host";
      path = "${pkgs.pywalfox-native}/bin/pywalfox";
      type = "stdio";
      allowed_extensions = [ "pywalfox@frewacom.org" ];
    };

    home.file.".cache/wal/colors.json".text = builtins.toJSON {
      wallpaper = "${wallpaper}";
      alpha = "100";
      colors = {
        color0 = "#${colors.base00}";
        color1 = "#${colors.base08}";
        color2 = "#${colors.base0B}";
        color3 = "#${colors.base0A}";
        color4 = "#${colors.base0D}";
        color5 = "#${colors.base0E}";
        color6 = "#${colors.base0C}";
        color7 = "#${colors.base05}";
        color8 = "#${colors.base03}";
        color9 = "#${colors.base05}";
        color10 = "#${colors.base0B}";
        color11 = "#${colors.base0A}";
        color12 = "#${colors.base0D}";
        color13 = "#${colors.base0E}";
        color14 = "#${colors.base0C}";
        color15 = "#${colors.base07}";
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/programs/applications/zen-browser.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/applications/default.nix
Extension: .nix
================================================

{
  imports = [
    ./firefox.nix
    ./rclone.nix
    ./obs.nix
    ./zen-browser.nix
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/programs/applications/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/git.nix
Extension: .nix
================================================

{ pkgs, ... }:
{
  config = {
    home.packages = with pkgs; [
      gh
    ];

    programs.git = {
      enable = true;
      package = pkgs.git;

      diff-so-fancy.enable = true;
      userName = "umokee";
      userEmail = "hituaev@gmail.com";

      extraConfig = {
        init.defaultBranch = "main";
      };

      ignores = [
        ".vscode/"
        ".idea/"
        "__pycache__/"
        ".syncrclone/"
        "node_modules/"

        "tags"
        "test.sh"
        ".luarc.json"
        "spell/"
        "lazy-lock.json"
      ];
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/git.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/vscode/settings.nix
Extension: .nix
================================================

{ config, pkgs, ... }:
{
  "editor.fontFamily" = "'JetBrainsMono Nerd Font', monospace";
  "editor.fontSize" = 18;
  "window.zoomLevel" = 1;

  "workbench.iconTheme" = "bearded-icons";
  "workbench.colorTheme" = "base16-ayu-dark";

  "editor.formatOnSave" = true;
  "editor.formatOnPaste" = false;
  "editor.codeActionsOnSave" = {
    "source.fixAll.eslint" = "explicit";
    "source.organizeImports" = "explicit";
  };

  "errorLens.enabled" = true;
  "errorLens.enabledDiagnosticLevels" = [
    "error"
    "warning"
    "info"
    "hint"
  ];
  "errorLens.fontSize" = "14";
  "errorLens.fontWeight" = "bold";
  "errorLens.fontStyleItalic" = true;
  "errorLens.gutterIconsEnabled" = true;
  "errorLens.messageTemplate" = "$message";
  "errorLens.delay" = 0;

  "problems.showCurrentInStatus" = true;
  "problems.sortOrder" = "severity";

  "editor.tabSize" = 2;
  "editor.detectIndentation" = false;
  "editor.lineNumbers" = "relative";
  "workbench.tree.indent" = 14;
  "files.insertFinalNewline" = true;

  "workbench.sideBar.location" = "left";
  "workbench.statusBar.visible" = false;
  "workbench.activityBar.location" = "hidden";
  "workbench.editor.showTabs" = "single";
  "workbench.startupEditor" = "none";
  "chat.commandCenter.enabled" = false;
  "workbench.layoutControl.enabled" = false;
  "window.customTitleBarVisibility" = "never";
  "window.titleBarStyle" = "native";
  "window.menuBarVisibility" = "toggle";

  "editor.scrollbar.vertical" = "hidden";
  "editor.scrollbar.horizontal" = "hidden";
  "editor.minimap.enabled" = true;
  "editor.minimap.renderCharacters" = false;

  "editor.multiCursorModifier" = "ctrlCmd";
  "editor.cursorBlinking" = "solid";
  "editor.matchBrackets" = "never";
  "editor.occurrencesHighlight" = "off";

  "editor.bracketPairColorization.enabled" = true;
  "editor.guides.bracketPairs" = true;

  "editor.lightbulb.enabled" = "off";
  "editor.showFoldingControls" = "never";
  "breadcrumbs.enabled" = false;
  "workbench.tips.enabled" = false;

  "editor.overviewRulerBorder" = false;
  "editor.hideCursorInOverviewRuler" = true;

  "editor.stickyScroll.enabled" = false;
  "workbench.tree.enableStickyScroll" = false;

  "explorer.confirmDragAndDrop" = true;
  "explorer.confirmDelete" = true;
  "explorer.decorations.badges" = false;
  "workbench.tree.renderIndentGuides" = "none";

  "git.decorations.enabled" = false;
  "scm.diffDecorations" = "none";

  "files.autoSave" = "afterDelay";
  "editor.wordWrap" = "on";
  "update.mode" = "none";

  "[python]" = {
    "editor.defaultFormatter" = "ms-python.autopep8";
    "editor.formatOnSave" = true;
    "editor.tabSize" = 4;
  };

  "nix.enableLanguageServer" = true;
  "nix.serverPath" = "${pkgs.nixd}/bin/nixd";
  "nix.formatterPath" = "${pkgs.nixfmt-rfc-style}/bin/nixfmt";

  "[nix]" = {
    "editor.defaultFormatter" = "jnoortheen.nix-ide";
    "editor.formatOnSave" = true;
    "editor.tabSize" = 2;
  };

  "nix.serverSettings" = {
    "nixd" = {
      "formatting" = {
        "command" = [ "${pkgs.nixfmt-rfc-style}/bin/nixfmt" ];
      };
      "options" = {
        "nixos" = {
          "expr" = "(builtins.getFlake \"/home/${config.home.username}/nix-dots\").nixosConfigurations.desktop.options";
        };
        "home-manager" = {
          "expr" = "(builtins.getFlake \"/home/${config.home.username}/nix-dots\").homeConfigurations.desktop.options";
        };
      };
    };
  };

  "editor.defaultFormatter" = "esbenp.prettier-vscode";
  "[vue]" = {
    "editor.defaultFormatter" = "esbenp.prettier-vscode";
  };
  "[javascript]" = {
    "editor.defaultFormatter" = "esbenp.prettier-vscode";
  };
  "[css]" = {
    "editor.defaultFormatter" = "esbenp.prettier-vscode";
  };
  "vetur.format.defaultFormatter.html" = "prettier";
  "vetur.format.defaultFormatter.js" = "prettier-eslint";
  "vetur.validation.template" = true;
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/vscode/settings.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/vscode/extensions.nix
Extension: .nix
================================================

{ pkgsWithOverlay, ... }:
with pkgsWithOverlay.vscode-marketplace-release;
[
  ms-python.autopep8
  jnoortheen.nix-ide
  usernamehw.errorlens
  beardedbear.beardedicons
  tintedtheming.base16-tinted-themes
  ms-python.python
  vue.volar
  esbenp.prettier-vscode
  dbaeumer.vscode-eslint
  octref.vetur
  vue.volar
]

=================== END FILE ===================
File: ./modules/home-manager/programs/development/vscode/extensions.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/vscode/default.nix
Extension: .nix
================================================

{
  config,
  pkgs,
  inputs,
  ...
}:
let
  pkgsWithOverlay = import pkgs.path {
    system = pkgs.system;
    overlays = [ inputs.nix-vscode-extensions.overlays.default ];
    config = pkgs.config;
  };

  userSettings = import ./settings.nix {
    inherit config pkgs;
  };
  keybindings = import ./keybindings.nix { };
  extensions = import ./extensions.nix { inherit pkgsWithOverlay; };
in
{
  programs.vscode = {
    enable = true;
    package = pkgs.vscode;
    #mutableExtensionsDir = true;

    profiles.default = {
      inherit userSettings keybindings extensions;
    };
  };

  #home.activation.makeVSCodeConfigWritable =
  #  let
  #    configPath = "${config.xdg.configHome}/Code/User/settings.json";
  #  in
  #  {
  #    after = [ "writeBoundary" ];
  #    before = [ ];
  #    data = ''
  #      if [ -L ${configPath} ]; then
  #        install -m 0640 "$(readlink ${configPath})" ${configPath}
  #      fi
  #    '';
  #  };
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/vscode/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/vscode/keybindings.nix
Extension: .nix
================================================

{ ... }:
[
  {
    key = "alt+d";
    command = "workbench.view.explorer";
  }
  {
    key = "alt+g";
    command = "workbench.view.scm";
  }
  {
    key = "alt+x";
    command = "workbench.view.extensions";
  }
  {
    key = "alt+t";
    command = "workbench.action.terminal.toggleTerminal";
  }
  {
    key = "ctrl+5";
    command = "workbench.view.debug";
  }
  {
    key = "ctrl+6";
    command = "workbench.view.search";
  }
  {
    key = "ctrl+b";
    command = "workbench.action.toggleSidebarVisibility";
  }
  {
    key = "ctrl+j";
    command = "workbench.action.togglePanel";
  }
]

=================== END FILE ===================
File: ./modules/home-manager/programs/development/vscode/keybindings.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/languages.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  helpers,
  ...
}:
let
  pythonWithPackages = pkgs.python3.withPackages (
    ps: with ps; [
      pytubefix
      requests
      numpy
      pillow
      cairosvg
      autopep8
    ]
  );
in
{
  home.packages =
    with pkgs;
    [ ]
    ++ lib.optionals (helpers.hasIn "programs" "nodejs") [
      nodejs_20
      yarn
      pnpm
      nodePackages.prettier
      nodePackages.eslint
      nodePackages.vscode-langservers-extracted
    ]
    ++ lib.optionals (helpers.hasIn "programs" "dotnet") [
      dotnet-sdk_9
    ]
    ++ lib.optionals (helpers.hasIn "programs" "nix-lang") [
      nixd
      nixfmt
      nixd
    ]
    ++ lib.optionals (helpers.hasIn "programs" "python-lang") [
      pythonWithPackages
    ];
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/languages.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/default.nix
Extension: .nix
================================================

{ pkgs, config, ... }:
{
  programs.neovim = {
    enable = true;
    defaultEditor = true;
    viAlias = true;
    vimAlias = true;

    # –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ Nix
    extraPackages = with pkgs; [
      gcc
      gnumake
      unzip
      git
      ripgrep
      fd
      tree-sitter

      # LSP —Å–µ—Ä–≤–µ—Ä—ã
      nil
      lua-language-server
      nodePackages.vscode-langservers-extracted
      nodePackages.typescript-language-server
      pyright

      # –§–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã
      stylua
      nixfmt-rfc-style
      black
      nodePackages.prettier

      # –õ–∏–Ω—Ç–µ—Ä—ã
      markdownlint-cli
    ];

    plugins = [ ];
  };

  # Symlink –Ω–∞ –≤—Å—é –ø–∞–ø–∫—É config
  xdg.configFile."nvim" = {
    source = config.lib.file.mkOutOfStoreSymlink "${config.home.homeDirectory}/nixos/modules/home-manager/programs/development/nvim/config";
    recursive = true;
  };
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/default.nix
Extension: .nix
================================================

{
  imports = [
    ./git.nix
    ./vscode
    #./nvim
    ./languages.nix
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/default.nix
Extension: .nix
================================================

{
  imports = [
    ./packages.nix
    ./applications
    ./development
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/programs/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/tofi.nix
Extension: .nix
================================================

{
  config,
  lib,
  helpers,
  conf,
  ...
}:
let
  colors = config.colorScheme.palette;
in
{
  programs.tofi = lib.mkIf (!helpers.isDwl) {
    enable = true;

    settings = {
      anchor = "top";
      width = "100%";
      height = 40;
      margin-top = 0;
      margin-bottom = 0;

      border-width = 0;
      outline-width = 0;

      horizontal = true;
      result-spacing = 25;
      num-results = 8;

      font = "JetBrainsMono Nerd Font Mono";
      font-style = "Bold";
      font-size = 12;

      background-color = "#${colors.base00}"; # –§–æ–Ω
      text-color = "#${colors.base05}"; # –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç
      prompt-color = "#${colors.base0D}"; # –ü—Ä–æ–º–ø—Ç (—Å–∏–Ω–∏–π)
      placeholder-color = "#${colors.base03}"; # Placeholder
      selection-color = "#${colors.base0D}"; # –í—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç (—Å–∏–Ω–∏–π)
      selection-background = "#${colors.base02}"; # –§–æ–Ω –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
      selection-match-color = "#${colors.base0B}"; # –°–æ–≤–ø–∞–¥–µ–Ω–∏—è (–∑–µ–ª—ë–Ω—ã–π)

      prompt-text = "run: ";
      placeholder-text = "...";

      fuzzy-match = true;
      hide-cursor = true;
      history = true;

      drun-launch = true;
      terminal = conf.default.terminal;
    };
  };

  home.activation.clearTofiCache = lib.hm.dag.entryAfter [ "writeBoundary" ] ''
    rm -f ${config.home.homeDirectory}/.cache/tofi-drun
  '';
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/tofi.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/dunst.nix
Extension: .nix
================================================

{
  helpers,
  ...
}:
{
  services.dunst = {
    enable = true;
    settings = {
      global = {
        monitor = if helpers.isDesktop then "DP-3" else "eDP-1";
        origin = "bottom-center";
        offset = "(0, 20)";
        width = "(300, 500)";
        height = 300;

        transparency = 10;
        padding = 12;
        horizontal_padding = 12;
        text_icon_padding = 16;

        frame_width = 2;
        corner_radius = 0;
        gap_size = 6;

        font = "JetBrainsMono Nerd Font 13";
        format = "<b>%s</b>\\n%b";
        markup = "full";
        alignment = "left";
        vertical_alignment = "center";

        icon_position = "left";
        min_icon_size = 48;
        max_icon_size = 64;
        icon_theme = "Papirus_Dark";
        enable_recursive_icon_lookup = true;

        sticky_history = true;
        history_length = 50;
        show_indicators = true;
        show_age_threshold = 60;
        stack_duplicates = true;
        hide_duplicate_count = false;
        notification_limit = 5;

        progress_bar = true;
        progress_bar_height = 14;
        progress_bar_frame_width = 1;
        progress_bar_min_width = 150;
        progress_bar_max_width = 300;
        progress_bar_corner_radius = 5;

        sort = true;
        idle_threshold = 120;
        word_wrap = true;
        ignore_newline = false;

        mouse_left_click = "close_current";
        mouse_middle_click = "do_action, close_current";
        mouse_right_click = "close_all";

        layer = "overlay";
        force_xwayland = false;

        browser = "/usr/bin/xdg-open";
        dmenu = "rofi -dmenu";
      };

      urgency_low = {
        timeout = 3;
      };

      urgency_normal = {
        timeout = 6;
      };

      urgency_critical = {
        timeout = 0;
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/dunst.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/scripts/detect-process.nix
Extension: .nix
================================================

{
  pkgs,
  ...
}:
{
  config = {
    home.file.".local/bin/detect-process" = {
      executable = true;
      text = ''
        #!${pkgs.bash}/bin/bash
        set -euo pipefail

        if [ $# -eq 0 ]; then
            echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–∏–º—è_–ø—Ä–æ—Ü–µ—Å—Å–∞>"
            echo "–ü—Ä–∏–º–µ—Ä: $0 bottles"
            echo "–ü—Ä–∏–º–µ—Ä: $0 mullvad-browser"
            exit 1
        fi

        PROCESS_NAME="$1"
        TEMP_FILE=$(mktemp)

        echo "üîç –ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–ª—è: $PROCESS_NAME"
        echo ""

        # –ù–∞–π—Ç–∏ –≤—Å–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
        ps -eo pid,comm,args | grep -i "$PROCESS_NAME" | grep -v grep | grep -v "$0" > "$TEMP_FILE" || {
            echo "‚ùå –ü—Ä–æ—Ü–µ—Å—Å '$PROCESS_NAME' –Ω–µ –∑–∞–ø—É—â–µ–Ω"
            echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
            rm -f "$TEMP_FILE"
            exit 1
        }

        echo "üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
        cat "$TEMP_FILE"
        echo ""

        # –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ –ø—É—Ç–∏
        declare -A paths
        declare -A packages

        while read -r line; do
            # –ò–∑–≤–ª–µ–∫–∞–µ–º PID
            pid=$(echo "$line" | awk '{print $1}')
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–º—É —Ñ–∞–π–ª—É
            if [ -e "/proc/$pid/exe" ]; then
                exe_path=$(sudo readlink -f "/proc/$pid/exe" 2>/dev/null || echo "")
                if [ -n "$exe_path" ]; then
                    paths["$exe_path"]=1
                    
                    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º Nix –ø–∞–∫–µ—Ç - –ò–°–ü–†–ê–í–õ–ï–ù–û
                    nix_store_regex='^/nix/store/([^/]+)'
                    if [[ "$exe_path" =~ $nix_store_regex ]]; then
                        pkg="''${BASH_REMATCH[1]}"
                        packages["$pkg"]=1
                    fi
                fi
            fi
            
            # –¢–∞–∫–∂–µ –ø–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
            args=$(echo "$line" | awk '{$1=$2=""; print $0}' | xargs)
            
            # –ò—â–µ–º /nix/store –ø—É—Ç–∏ –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö - –ò–°–ü–†–ê–í–õ–ï–ù–û
            for arg in $args; do
                if [[ "$arg" =~ $nix_store_regex ]]; then
                    pkg="''${BASH_REMATCH[1]}"
                    packages["$pkg"]=1
                fi
            done
        done < "$TEMP_FILE"

        rm -f "$TEMP_FILE"

        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "‚ú® –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è Sing-Box –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º process_path_regex
        echo "üìù process_path_regex (–¥–æ–±–∞–≤–∏—Ç—å –≤ route.rules):"
        echo ""
        echo "{"
        echo "  process_path_regex = ["

        for path in "''${!paths[@]}"; do
            # –°–æ–∑–¥–∞—ë–º regex –∏–∑ –ø—É—Ç–∏
            # –ó–∞–º–µ–Ω—è–µ–º —Ö–µ—à–∏ Nix –Ω–∞ .*
            regex=$(echo "$path" | sed 's|/nix/store/[^/]*|/nix/store/[^/]*|g')
            
            # –û–±–æ–±—â–∞–µ–º –ø—É—Ç—å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –ø–∞–∫–µ—Ç–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–û
            version_regex='(.*/)[^/]+-([0-9]+\.[0-9]+.*)/(.+)'
            if [[ "$regex" =~ $version_regex ]]; then
                base="''${BASH_REMATCH[1]}"
                name_part=$(echo "$path" | grep -oP '/nix/store/[^/]+-\K[^-/]+' | head -1 || echo "")
                suffix="''${BASH_REMATCH[3]}"
                if [ -n "$name_part" ] && [ -n "$suffix" ]; then
                    regex=".*/$name_part.*/$suffix"
                fi
            fi
            
            echo "    \"$regex\""
        done

        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        echo "    \".*$PROCESS_NAME.*\""

        echo "  ];"
        echo "  outbound = \"proxy\";"
        echo "}"
        echo ""

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º package_name (–µ—Å–ª–∏ –±—É–¥–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è)
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ Nix –ø–∞–∫–µ—Ç—ã:"
        echo ""
        for pkg in "''${!packages[@]}"; do
            echo "  - $pkg"
        done
        echo ""

        # –°–æ–∑–¥–∞—ë–º –ø–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üìÑ –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –¥–ª—è NixOS –∫–æ–Ω—Ñ–∏–≥–∞:"
        echo ""
        echo "route = {"
        echo "  rules = ["
        echo "    # DNS hijack –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤—ã–º"
        echo "    {"
        echo "      protocol = \"dns\";"
        echo "      action = \"hijack-dns\";"
        echo "    }"
        echo "    # –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è $PROCESS_NAME"
        echo "    {"
        echo "      process_path_regex = ["

        for path in "''${!paths[@]}"; do
            regex=$(echo "$path" | sed 's|/nix/store/[^/]*|/nix/store/[^/]*|g')
            echo "        \"$regex\""
        done
        echo "        \".*$PROCESS_NAME.*\""

        echo "      ];"
        echo "      outbound = \"proxy\";"
        echo "    }"
        echo "    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞"
        echo "  ];"
        echo "};"
      '';
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/scripts/detect-process.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/scripts/collect.nix
Extension: .nix
================================================

{
  pkgs,
  ...
}:
{
  config = {
    home.file.".local/bin/collect" = {
      executable = true;
      text = ''
        #!${pkgs.bash}/bin/bash

        if [ "$#" -lt 2 ]; then
          echo "Usage: $0 <directory> <extension> [output_file] [excluded_dirs]"
          echo "Example: $0 /path/to/dir .txt output.txt"
          echo "Example with multiple extensions: $0 /path/to/dir '.txt .md .sh' output.txt"
          echo "Example with excluded dirs: $0 /path/to/dir .txt output.txt 'node_modules .git dist'"
          exit 1
        fi

        DIRECTORY="$1"
        EXTENSIONS="$2"
        OUTPUT_FILE="''${3:-merged_output.txt}"
        EXCLUDED_DIRS="''${4:-}"

        if [ ! -d "$DIRECTORY" ]; then
          echo "Error: Directory '$DIRECTORY' does not exist"
          exit 1
        fi

        > "$OUTPUT_FILE"

        echo "Starting file collection from: $DIRECTORY"
        echo "Extensions: $EXTENSIONS"
        echo "Output file: $OUTPUT_FILE"
        if [ -n "$EXCLUDED_DIRS" ]; then
          echo "Excluded directories: $EXCLUDED_DIRS"
        fi
        echo ""

        COUNT=0

        build_exclude_args() {
          local args=()
          if [ -n "$EXCLUDED_DIRS" ]; then
            local first=true
            for dir in $EXCLUDED_DIRS; do
              if [ "$first" = true ]; then
                args+=("(" "-path" "*/$dir" "-prune")
                first=false
              else
                args+=("-o" "-path" "*/$dir" "-prune")
              fi
            done
            args+=(")" "-o")
          fi
          printf '%s\n' "''${args[@]}"
        }

        process_extension() {
          local ext="$1"
          
          ext="''${ext#.}"
          
          local exclude_args=()
          if [ -n "$EXCLUDED_DIRS" ]; then
            readarray -t exclude_args < <(build_exclude_args)
          fi
          
          while IFS= read -r -d ''' file; do
            echo "–û–±—Ä–∞–±–æ—Ç–∫–∞: $file"
            echo "================== BEGIN FILE ==================" >> "$OUTPUT_FILE"
            echo "File: $file" >> "$OUTPUT_FILE"
            echo "Extension: .$ext" >> "$OUTPUT_FILE"
            echo "================================================" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
            
            cat "$file" >> "$OUTPUT_FILE"
            
            echo "" >> "$OUTPUT_FILE"
            echo "=================== END FILE ===================" >> "$OUTPUT_FILE"
            echo "File: $file" >> "$OUTPUT_FILE"
            echo "================================================" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
            
            ((COUNT++))
          done < <(
            if [ ''${#exclude_args[@]} -gt 0 ]; then
              find "$DIRECTORY" "''${exclude_args[@]}" -type f -name "*.$ext" -print0
            else
              find "$DIRECTORY" -type f -name "*.$ext" -print0
            fi
          )
        }

        for extension in $EXTENSIONS; do
          process_extension "$extension"
        done

        echo ""
        echo "Complete! Files processed: $COUNT"
        echo "Result saved to: $OUTPUT_FILE"
      '';
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/scripts/collect.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/scripts/screenshots.nix
Extension: .nix
================================================

{
  config,
  lib,
  pkgs,
  helpers,
  ...
}:
let
  directory = "${config.home.homeDirectory}/Pictures/Screenshots";
  selectedTool = if helpers.isWayland then "grim" else "maim";
in
{
  config = lib.mkIf helpers.isWM (
    lib.mkMerge [
      (lib.mkIf helpers.isWayland {
        home.packages = [
          pkgs.grim
          pkgs.slurp
          pkgs.jq
        ];
      })
      (lib.mkIf helpers.isX11 {
        home.packages = [
          pkgs.maim
          pkgs.xclip
          pkgs.xdotool
        ];
      })
      {
        home.activation.createScreenshotDir = lib.hm.dag.entryAfter [ "writeBoundary" ] ''
          mkdir -p ${directory}
        '';

        home.file.".local/bin/screenshot-tool" = {
          executable = true;
          text = ''
            #!${pkgs.bash}/bin/bash

            DIR="${directory}"

            get_next_number() {
              local i=1
              while [[ -e "$DIR/screenshot-$i.png" ]]; do
                ((i++))
              done
              echo "$i"
            }

            NUM=$(get_next_number)
            FILE="$DIR/screenshot-$NUM.png"

            case "$1" in
              "window")
                if [[ "${selectedTool}" == "grim" ]]; then
                  ${pkgs.hyprland}/bin/hyprctl -j activewindow | \
                    ${pkgs.jq}/bin/jq -r '"\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"' | \
                    ${pkgs.grim}/bin/grim -g - "$FILE"
                  ${pkgs.wl-clipboard}/bin/wl-copy < "$FILE"
                else
                  ${pkgs.maim}/bin/maim -i $(${pkgs.xdotool}/bin/xdotool getactivewindow) "$FILE"
                  ${pkgs.xclip}/bin/xclip -selection clipboard -t image/png < "$FILE"
                fi
                echo "Saved: $FILE"
                ;;
              
              "area")
                if [[ "${selectedTool}" == "grim" ]]; then
                  ${pkgs.grim}/bin/grim -g "$(${pkgs.slurp}/bin/slurp)" "$FILE"
                  ${pkgs.wl-clipboard}/bin/wl-copy < "$FILE"
                else
                  ${pkgs.maim}/bin/maim -s "$FILE"
                  ${pkgs.xclip}/bin/xclip -selection clipboard -t image/png < "$FILE"
                fi
                echo "Saved: $FILE"
                ;;
              
              "full")
                if [[ "${selectedTool}" == "grim" ]]; then
                  ${pkgs.grim}/bin/grim "$FILE"
                  ${pkgs.wl-clipboard}/bin/wl-copy < "$FILE"
                else
                  ${pkgs.maim}/bin/maim "$FILE"
                  ${pkgs.xclip}/bin/xclip -selection clipboard -t image/png < "$FILE"
                fi
                echo "Saved: $FILE"
                ;;
              
              "clip")
                if [[ "${selectedTool}" == "grim" ]]; then
                  ${pkgs.grim}/bin/grim -g "$(${pkgs.slurp}/bin/slurp)" - | \
                    ${pkgs.wl-clipboard}/bin/wl-copy -t image/png
                else
                  ${pkgs.maim}/bin/maim -s | \
                    ${pkgs.xclip}/bin/xclip -selection clipboard -t image/png
                fi
                echo "Copied to clipboard"
                ;;
              
              *)
                echo "Usage: $0 {window|area|full|clip}"
                echo "  window - Screenshot active window"
                echo "  area   - Screenshot selected area"
                echo "  full   - Screenshot entire screen"
                echo "  clip   - Screenshot area to clipboard only"
                ;;
            esac
          '';
        };
      }
    ]
  );
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/scripts/screenshots.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/scripts/default.nix
Extension: .nix
================================================

{
  imports = [
    ./collect.nix
    ./screenshots.nix
    ./detect-process.nix
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/scripts/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/xdg.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  helpers,
  ...
}:
{
  config = lib.mkIf helpers.isWM {
    home.packages = with pkgs; [
      xdg-utils
    ];

    xdg = {
      enable = true;

      mimeApps = {
        enable = true;
        defaultApplications = {
          "text/html" = "zen.desktop";
          "application/xhtml+xml" = "zen.desktop";
          "application/pdf" = "zen.desktop";
          "x-scheme-handler/http" = "zen.desktop";
          "x-scheme-handler/https" = "zen.desktop";
          "x-scheme-handler/about" = "zen.desktop";
          "x-scheme-handler/unknown" = "zen.desktop";

          # Images
          "image/jpeg" = "qimgv.desktop";
          "image/png" = "qimgv.desktop";
          "image/gif" = "qimgv.desktop";
          "image/webp" = "qimgv.desktop";
          "image/bmp" = "qimgv.desktop";
          "image/icon" = "qimgv.desktop";

          "video/webm" = "qimgv.desktop";
          "video/mp4" = "qimgv.desktop";
          "video/x-matroska" = "qimgv.desktop";
          "video/avi" = "qimgv.desktop";

          "audio/webm" = "qimgv.desktop";
          "audio/wav" = "qimgv.desktop";
          "audio/ogg" = "qimgv.desktop";
          "audio/opus" = "qimgv.desktop";
          "audio/flac" = "qimgv.desktop";
          "audio/mp4" = "qimgv.desktop";
          "audio/mpeg" = "qimgv.desktop";
          "audio/mp3" = "qimgv.desktop";

          "text/plain" = "code.desktop";
          "text/markdown" = "code.desktop";
          "text/x-csrc" = "code.desktop";
          "text/x-chdr" = "code.desktop";
          "text/x-c++src" = "code.desktop";
          "text/x-c++hdr" = "code.desktop";
          "text/x-python" = "code.desktop";
          "text/x-script.python" = "code.desktop";
          "text/x-rust" = "code.desktop";
          "text/x-java" = "code.desktop";
          "text/x-go" = "code.desktop";
          "text/javascript" = "code.desktop";
          "application/javascript" = "code.desktop";
          "application/x-javascript" = "code.desktop";
          "text/x-javascript" = "code.desktop";
          "application/json" = "code.desktop";
          "application/xml" = "code.desktop";
          "text/xml" = "code.desktop";
          "text/x-shellscript" = "code.desktop";
          "application/x-shellscript" = "code.desktop";
          "text/x-sh" = "code.desktop";

          # Archives
          "application/zip" = "xarchiver.desktop";
          "application/x-7z-compressed" = "xarchiver.desktop";
          "application/x-rar" = "xarchiver.desktop";
          "application/x-tar" = "xarchiver.desktop";
          "application/gzip" = "xarchiver.desktop";

          # File manager for directories
          "inode/directory" = "nemo.desktop";
        };
      };

      userDirs = {
        enable = true;
        createDirectories = true;
      };

      portal = {
        enable = true;
        xdgOpenUsePortal = true;

        extraPortals =
          with pkgs;
          [
            xdg-desktop-portal-gtk
          ]
          ++ lib.optionals helpers.isWlr [
            xdg-desktop-portal-wlr
          ]
          ++ lib.optionals helpers.isHyprland [
            xdg-desktop-portal-hyprland
          ];

        config = {
          hyprland = {
            default = [
              "hyprland"
              "gtk"
            ];
            "org.freedesktop.impl.portal.ScreenCast" = [ "hyprland" ];
            "org.freedesktop.impl.portal.Screenshot" = [ "hyprland" ];
            "org.freedesktop.impl.portal.Settings" = "gtk";
            "org.freedesktop.impl.portal.FileChooser" = "gtk";
            "org.freedesktop.impl.portal.Inhibit" = "gtk";
          };
          mangowc = {
            default = [
              "wlr"
              "gtk"
            ];
            "org.freedesktop.impl.portal.ScreenCast" = [ "wlr" ];
            "org.freedesktop.impl.portal.Screenshot" = [ "wlr" ];
            "org.freedesktop.impl.portal.Settings" = "gtk";
            "org.freedesktop.impl.portal.FileChooser" = "gtk";
            "org.freedesktop.impl.portal.Inhibit" = "gtk";
          };
          common = {
            default = [ "gtk" ];
          };
        };
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/xdg.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/WMs/mangowc/rules.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "workspace" "mangowc";
  monitorTags = {
    "DP-3" = {
      "1" = "tile";
      "2" = "tile";
      "3" = "tile";
      "4" = "tile";
      "5" = "tile";
      "6" = "tile";
      "7" = "tile";
      "8" = "tile";
      "9" = "tile";
    };
    "DP-4" = {
      "1" = "scroller";
      "2" = "scroller";
      "3" = "scroller";
      "4" = "scroller";
      "5" = "scroller";
      "6" = "vscroller";
      "7" = "scroller";
      "8" = "scroller";
      "9" = "scroller";
    };
    "HDMI-A-5" = {
      "1" = "tile";
      "2" = "tile";
      "3" = "tile";
      "4" = "tile";
      "5" = "tile";
      "6" = "tile";
      "7" = "tile";
      "8" = "tile";
      "9" = "tile";
    };
  };

  generateTagRules = lib.concatStringsSep "\n" (
    lib.flatten (
      lib.mapAttrsToList (
        monitor: tags:
        lib.mapAttrsToList (
          id: layout: "tagrule=id:${id},monitor_name:${monitor},layout_name:${layout}"
        ) tags
      ) monitorTags
    )
  );
in
{
  config = lib.mkIf enable {
    home.file.".config/mango/rules.conf".text = ''
      # Tag rules
      ${generateTagRules}

      # Window rules
      windowrule=focused_opacity:0.95,unfocused_opacity:0.95
      windowrule=focused_opacity:1.0,unfocused_opacity:1.0,noblur:1,appid:foot|equibop|org\.quickshell|imv|swappy

      # Float rules
      windowrule=isfloating:1,no_force_center:0,appid:guifetch
      windowrule=isfloating:1,no_force_center:0,appid:yad
      windowrule=isfloating:1,no_force_center:0,appid:zenity
      windowrule=isfloating:1,no_force_center:0,appid:wev
      windowrule=isfloating:1,no_force_center:0,appid:org\.gnome\.FileRoller
      windowrule=isfloating:1,no_force_center:0,appid:file-roller
      windowrule=isfloating:1,no_force_center:0,appid:blueman-manager
      windowrule=isfloating:1,no_force_center:0,appid:com\.github\.GradienceTeam\.Gradience
      windowrule=isfloating:1,no_force_center:0,appid:feh
      windowrule=isfloating:1,no_force_center:0,appid:imv
      windowrule=isfloating:1,no_force_center:0,appid:system-config-printer
      windowrule=isfloating:1,no_force_center:0,appid:org\.quickshell

      # Float + size rules
      windowrule=isfloating:1,width:800,height:600,no_force_center:0,appid:foot,title:nmtui
      windowrule=isfloating:1,width:1000,height:800,no_force_center:0,appid:org\.gnome\.Settings
      windowrule=isfloating:1,width:900,height:700,no_force_center:0,appid:org\.pulseaudio\.pavucontrol|yad-icon-browser
      windowrule=isfloating:1,width:800,height:600,no_force_center:0,appid:nwg-look

      # Title-based float rules
      windowrule=isfloating:1,no_force_center:0,title:(Select|Open)( a)? (File|Folder)(s)?
      windowrule=isfloating:1,no_force_center:0,title:File (Operation|Upload)( Progress)?
      windowrule=isfloating:1,no_force_center:0,title:.* Properties
      windowrule=isfloating:1,no_force_center:0,title:Export Image as PNG
      windowrule=isfloating:1,no_force_center:0,title:GIMP Crash Debug
      windowrule=isfloating:1,no_force_center:0,title:Save As
      windowrule=isfloating:1,no_force_center:0,title:Library

      # Picture-in-Picture
      windowrule=isfloating:1,offsetx:45,offsety:45,width:400,height:300,isoverlay:1,title:Picture(-| )in(-| )[Pp]icture

      # Steam rules
      windowrule=isfloating:1,no_force_center:0,title:(Friends List|Steam Settings),appid:steam
      windowrule=appid:steam_app_[0-9]+

      # ATLauncher
      windowrule=isfloating:1,no_force_center:0,appid:com-atlauncher-App,title:ATLauncher Console

      # Fusion360
      windowrule=noblur:1,title:Fusion360|(Marking Menu),appid:fusion360\.exe
    '';
  };
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/WMs/mangowc/rules.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/WMs/mangowc/default.nix
Extension: .nix
================================================

{
  config,
  lib,
  helpers,
  pkgs,
  ...
}:
let
  enable = helpers.hasIn "workspace" "mangowc";
  colors = config.colorScheme.palette;
in
{
  imports = [
    ./binds.nix
    ./rules.nix
  ];

  config = lib.mkIf enable {
    programs.bash.profileExtra = lib.mkIf helpers.isWM ''
      if [ -z "$WAYLAND_DISPLAY" ] && [ "$XDG_VTNR" = 1 ]; then
        exec mango
      fi
    '';

    wayland.windowManager.mango = {
      enable = true;
      settings = ''
        # https://github.com/DreamMaoMao/mango/wiki/

        # Window effect
        blur=0
        blur_layer=0

        shadows = 0
        layer_shadows = 0
        shadow_only_floating = 1
        shadows_size = 10
        shadows_blur = 15
        shadows_position_x = 0
        shadows_position_y = 0
        shadowscolor= 0x000000ff

        # Animation Configuration
        animations=0
        layer_animations=0

        # Scroller Layout Setting
        scroller_structs=20
        scroller_default_proportion=1.0
        scroller_focus_center=0
        scroller_prefer_center=0
        edge_scroller_pointer_focus=1
        scroller_default_proportion_single=1.0
        scroller_proportion_preset=0.5,0.8,1.0

        # Master-Stack Layout Setting
        new_is_master=1
        default_mfact=0.50
        default_nmaster=1
        smartgaps=0

        # Overview Setting
        hotarea_size=10
        enable_hotarea=0
        ov_tab_mode=0
        overviewgappi=2
        overviewgappo=10

        # Misc
        no_border_when_single=0
        axis_bind_apply_timeout=100
        focus_on_activate=0
        inhibit_regardless_of_visibility=0
        sloppyfocus=1
        warpcursor=1
        focus_cross_monitor=0
        focus_cross_tag=0
        enable_floating_snap=0
        snap_distance=30
        cursor_size=24
        drag_tile_to_tile=1

        # Mouse
        mouse_natural_scrolling=0

        # Keyboard
        repeat_rate=50
        repeat_delay=300
        numlockon=0
        xkb_rules_layout=us,ru-custom
        xkb_rules_options=grp:ctrl_shift_toggle

        # Trackpad
        disable_trackpad=${if helpers.isLaptop then "1" else "0"}
        tap_to_click=1
        tap_and_drag=1
        drag_lock=1
        trackpad_natural_scrolling=0
        disable_while_typing=1
        left_handed=0
        middle_button_emulation=0
        swipe_min_threshold=1

        # Appearance
        border_radius=0
        no_radius_when_single=0
        focused_opacity=1.0
        unfocused_opacity=1.0
        borderpx=1
        gappih=2
        gappiv=2
        gappoh=2
        gappov=2
        scratchpad_width_ratio=0.8
        scratchpad_height_ratio=0.9

        rootcolor=0x${colors.base00}ff
        bordercolor=0x${colors.base03}ff
        focuscolor=0x${colors.base0D}ff
        maxmizescreencolor=0x${colors.base0B}ff
        urgentcolor=0x${colors.base08}ff
        scratchpadcolor=0x${colors.base0E}ff
        globalcolor=0x${colors.base0E}ff
        overlaycolor=0x${colors.base0C}ff

        source=~/.config/mango/binds.conf
        source=~/.config/mango/rules.conf
      '';
      autostart_sh = ''
        ${pkgs.dbus}/bin/dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP &
        systemctl --user import-environment WAYLAND_DISPLAY XDG_CURRENT_DESKTOP &
      '';
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/WMs/mangowc/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/WMs/mangowc/binds.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  pkgs,
  ...
}:
let
  enable = helpers.hasIn "workspace" "mangowc";
  mainBtn = "SUPER";
in
{
  config = lib.mkIf enable {
    home.file.".config/mango/binds.conf".text = ''
      bind=${mainBtn}+SHIFT,code:27,reload_config
      bind=${mainBtn},code:58,quit

      bind=${mainBtn},code:38,spawn,${pkgs.tofi}/bin/tofi-drun --drun-launch=true
      bind=${mainBtn},Return,spawn,foot
      bind=${mainBtn},code:25,spawn,zen
      bind=${mainBtn},code:26,spawn,nemo
      bind=${mainBtn},code:39,spawn,screenshot-tool area
      bind=${mainBtn},code:56,spawn_shell,pkill waybar || waybar &

      bind=${mainBtn},Tab,focusstack,next

      bind=${mainBtn}+SHIFT,code:43,exchange_client,up
      bind=${mainBtn}+SHIFT,code:44,exchange_client,down
      bind=${mainBtn}+SHIFT,code:45,exchange_client,left
      bind=${mainBtn}+SHIFT,code:46,exchange_client,right

      bind=${mainBtn},code:42,toggleglobal,
      bind=${mainBtn}+SHIFT,Tab,toggleoverview,
      bind=${mainBtn},f,togglemaxmizescreen, # togglefakefullscreen
      bind=${mainBtn},code:55,togglefloating,
      bind=${mainBtn},i,minimized,R
      bind=${mainBtn}+SHIFT,I,restore_minimized
      bind=${mainBtn},code:24,killclient,

      bind=${mainBtn},code:43,viewtoleft_have_client,0
      bind=${mainBtn},code:44,viewtoright_have_client,0
      bind=${mainBtn},code:45,tagtoleft,0
      bind=${mainBtn},code:46,tagtoright,0

      bind=${mainBtn},1,view,1,0
      bind=${mainBtn},2,view,2,0
      bind=${mainBtn},3,view,3,0
      bind=${mainBtn},4,view,4,0
      bind=${mainBtn},5,view,5,0
      bind=${mainBtn},6,view,6,0
      bind=${mainBtn},7,view,7,0
      bind=${mainBtn},8,view,8,0
      bind=${mainBtn},9,view,9,0

      # tag, tagsilent
      bind=${mainBtn}+SHIFT,1,tag,1,0
      bind=${mainBtn}+SHIFT,2,tag,2,0
      bind=${mainBtn}+SHIFT,3,tag,3,0
      bind=${mainBtn}+SHIFT,4,tag,4,0
      bind=${mainBtn}+SHIFT,5,tag,5,0
      bind=${mainBtn}+SHIFT,6,tag,6,0
      bind=${mainBtn}+SHIFT,7,tag,7,0
      bind=${mainBtn}+SHIFT,8,tag,8,0
      bind=${mainBtn}+SHIFT,9,tag,9,0

      # resizewin
      #bind=CTRL+ALT,Up,resizewin,+0,-50
      #bind=CTRL+ALT,Down,resizewin,+0,+50
      #bind=CTRL+ALT,Left,resizewin,-50,+0
      #bind=CTRL+ALT,Right,resizewin,+50,+0

      # Mouse Button Bindings
      mousebind=${mainBtn},btn_left,moveresize,curmove
      mousebind=${mainBtn},btn_right,moveresize,curresize
      axisbind=${mainBtn},UP,viewtoleft_have_client
      axisbind=${mainBtn},DOWN,viewtoright_have_client
    '';
  };
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/WMs/mangowc/binds.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/WMs/default.nix
Extension: .nix
================================================

{
  imports = [
    ./hyprland
    ./mangowc
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/WMs/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/WMs/hyprland/rules.nix
Extension: .nix
================================================

{
  windowrule = [
    "opacity 0.95 override, fullscreen:0"
    "opaque, class:foot|equibop|org\.quickshell|imv|swappy"
    "center 1, floating:1, xwayland:0"
    "float, class:guifetch"
    "float, class:yad"
    "float, class:zenity"
    "float, class:wev"
    "float, class:org\.gnome\.FileRoller"
    "float, class:file-roller"
    "float, class:blueman-manager"
    "float, class:com\.github\.GradienceTeam\.Gradience"
    "float, class:feh"
    "float, class:imv"
    "float, class:system-config-printer"
    "float, class:org\.quickshell"
    "float, class:foot, title:nmtui"
    "size 60% 70%, class:foot, title:nmtui"
    "center 1, class:foot, title:nmtui"
    "float, class:org\.gnome\.Settings"
    "size 70% 80%, class:org\.gnome\.Settings"
    "center 1, class:org\.gnome\.Settings"
    "float, class:org\.pulseaudio\.pavucontrol|yad-icon-browser"
    "size 60% 70%, class:org\.pulseaudio\.pavucontrol|yad-icon-browser"
    "center 1, class:org\.pulseaudio\.pavucontrol|yad-icon-browser"
    "float, class:nwg-look"
    "size 50% 60%, class:nwg-look"
    "center 1, class:nwg-look"
    "float, title:(Select|Open)( a)? (File|Folder)(s)?"
    "float, title:File (Operation|Upload)( Progress)?"
    "float, title:.* Properties"
    "float, title:Export Image as PNG"
    "float, title:GIMP Crash Debug"
    "float, title:Save As"
    "float, title:Library"
    "move 100%-w-2% 100%-w-3%, title:Picture(-| )in(-| )[Pp]icture"
    "keepaspectratio, title:Picture(-| )in(-| )[Pp]icture"
    "float, title:Picture(-| )in(-| )[Pp]icture"
    "pin, title:Picture(-| )in(-| )[Pp]icture"
    "rounding 10, title:, class:steam"
    "float, title:Friends List, class:steam"
    "immediate, class:steam_app_[0-9]+"
    "idleinhibit always, class:steam_app_[0-9]+"
    "float, class:com-atlauncher-App, title:ATLauncher Console"
    "noblur, title:Fusion360|(Marking Menu), class:fusion360\.exe"
    "nodim, xwayland:1, title:win[0-9]+"
    "noshadow, xwayland:1, title:win[0-9]+"
    "rounding 10, xwayland:1, title:win[0-9]+"
  ];

  windowrulev2 = [
    "noinitialfocus, class:^(.*jetbrains.*)$, title:^(win.*)$"
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/WMs/hyprland/rules.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/WMs/hyprland/keybinds.nix
Extension: .nix
================================================

{ pkgs }:
{
  bind = [
    "Super, A, exec, ${pkgs.tofi}/bin/tofi-drun --drun-launch=true"
    "Super, Return, exec, foot"
    "Super, W, exec, zen"
    "Super, E, exec, nemo"
    "Super+Shift, S, exec, screenshot-tool clip"
    "Super, Q, killactive,"
    "Super, V, togglefloating"
    "Super, F, fullscreen,"
    "Super, h, movefocus, l"
    "Super, l, movefocus, r"
    "Super, k, movefocus, u"
    "Super, j, movefocus, d"
    "Super+Shift, h, movewindow, l"
    "Super+Shift, l, movewindow, r"
    "Super+Shift, k, movewindow, u"
    "Super+Shift, j, movewindow, d"
    "Super, 1, workspace, 1"
    "Super, 2, workspace, 2"
    "Super, 3, workspace, 3"
    "Super, 4, workspace, 4"
    "Super, 5, workspace, 5"
    "Super, 6, workspace, 6"
    "Super, 7, workspace, 7"
    "Super, 8, workspace, 8"
    "Super, 9, workspace, 9"
    "Super, 0, workspace, 10"
    "Super+Shift, 1, movetoworkspace, 1"
    "Super+Shift, 2, movetoworkspace, 2"
    "Super+Shift, 3, movetoworkspace, 3"
    "Super+Shift, 4, movetoworkspace, 4"
    "Super+Shift, 5, movetoworkspace, 5"
    "Super+Shift, 6, movetoworkspace, 6"
    "Super+Shift, 7, movetoworkspace, 7"
    "Super+Shift, 8, movetoworkspace, 8"
    "Super+Shift, 9, movetoworkspace, 9"
    "Super+Shift, 0, movetoworkspace, 10"
  ];

  bindm = [
    "Super, mouse:272, movewindow"
    "Super, mouse:273, resizewindow"
  ];

  bindel = [
    ",XF86AudioRaiseVolume, exec, wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%"
    ",XF86AudioLowerVolume, exec, wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%"
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/WMs/hyprland/keybinds.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/WMs/hyprland/default.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  pkgs,
  ...
}:
let
  enable = helpers.hasIn "workspace" "hyprland";

  keybinds = import ./keybinds.nix { inherit pkgs; };
  rules = import ./rules.nix;
in
{
  config = lib.mkIf enable {
    programs.bash.profileExtra = lib.mkIf helpers.isWM ''
      if [ -z "$WAYLAND_DISPLAY" ] && [ "$XDG_VTNR" = 1 ]; then
        exec uwsm start hyprland-uwsm.desktop
      fi
    '';

    wayland.windowManager.hyprland = {
      enable = true;

      settings = {
        exec-once = [
          "dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP"
          "systemctl --user import-environment WAYLAND_DISPLAY XDG_CURRENT_DESKTOP"
          "echo 'Xft.dpi: 125' | xrdb -merge"
          "gsettings set org.gnome.desktop.interface text-scaling-factor 1.25"
        ];

        monitor = [ ",1920x1080@60, auto, 1" ];
        xwayland.force_zero_scaling = false;

        workspace = [
          "1, monitor:DP-3, default:true"
          "2, monitor:DP-3"
          "3, monitor:DP-3"
          "4, monitor:DP-3"
          "5, monitor:DP-3"
          "6, monitor:HDMI-A-5, default:true"
          "7, monitor:HDMI-A-5"
          "8, monitor:HDMI-A-5"
          "9, monitor:HDMI-A-5"
          "10, monitor:HDMI-A-5"
          "11, monitor:DP-4, default:true"
        ];

        input = {
          kb_layout = "us,ru-custom";
          kb_options = "grp:ctrl_shift_toggle";
          repeat_rate = 50;
          repeat_delay = 300;

          follow_mouse = 1;
          focus_on_close = 1;
          sensitivity = 0;

          touchpad = {
            natural_scroll = true;
            disable_while_typing = true;
            scroll_factor = 0.3;
          };
        };

        general = {
          gaps_in = 2;
          gaps_out = 2;
          border_size = 1;
          resize_on_border = false;
          allow_tearing = false;
          layout = "dwindle";
        };

        decoration = {
          rounding = 0;
          active_opacity = 1.0;
          inactive_opacity = 1.0;

          blur = lib.mkIf helpers.isDesktop {
            enabled = false;
            xray = false;
            special = false;
            ignore_opacity = true;
            new_optimizations = true;
            popups = true;
            input_methods = true;
            size = 8;
            passes = 2;
          };

          shadow = {
            enabled = false;
          };
        };

        animations = {
          enabled = false;
        };

        dwindle = {
          preserve_split = true;
          smart_split = false;
          smart_resizing = true;
        };

        misc = {
          vfr = true;
          vrr = 1;
          animate_manual_resizes = false;
          animate_mouse_windowdragging = false;
          disable_hyprland_logo = true;
          force_default_wallpaper = 0;
          new_window_takes_over_fullscreen = 2;
          allow_session_lock_restore = true;
          middle_click_paste = false;
          focus_on_activate = true;
          session_lock_xray = true;
        };
      }
      // keybinds
      // rules;
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/WMs/hyprland/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/default.nix
Extension: .nix
================================================

{
  imports = [
    ./WMs
    ./scripts
    ./waybar.nix
    ./wallpapers.nix
    ./dunst.nix
    ./tofi.nix
    ./xdg.nix
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/waybar.nix
Extension: .nix
================================================

{
  config,
  helpers,
  lib,
  ...
}:
{
  programs.waybar = lib.mkIf (!helpers.isDwl) {
    enable = true;
    systemd = {
      enable = true;
      target = "graphical-session.target";
    };

    settings = {
      mainBar = {
        output = [
          "DP-3"
          "HDMI-A-5"
          "eDP-1"
        ];
        layer = "top";
        position = "top";
        height = 30;
        spacing = 4;

        modules-left =
          [ ]
          ++ lib.optionals helpers.isHyprland [
            "hyprland/workspaces"
            "custom/sep"
            "hyprland/window"
            "custom/sep"
          ]
          ++ lib.optionals helpers.isMango [
            "ext/workspaces"
            "custom/sep"
            "dwl/window"
            "custom/sep"
          ];

        modules-center = [ ];

        modules-right =
          [ ]
          ++ lib.optionals helpers.isLaptop [
            "custom/sep"
            "battery"
          ]
          ++ [
            "custom/sep"
            "network"
            "custom/sep"
            "cpu"
            "custom/sep"
            "memory"
            "custom/sep"
            "disk"
            "custom/sep"
            "clock"
            "custom/sep"
            "tray"
          ];

        "hyprland/workspaces" = {
          disable-scroll = true;
          all-outputs = false;
          warp-on-scroll = false;
          format = "{name}";
          "persistent-workspaces" = {
            "eDP-1" = [
              1
              2
              3
              4
              5
              6
              7
              8
              9
              10
            ];
            "DP-3" = [
              1
              2
              3
              4
              5
            ];
            "DP-4" = [
              11
              12
              13
              14
              15
            ];
            "HDMI-A-5" = [
              6
              7
              8
              9
              10
            ];
          };
        };

        "hyprland/window" = {
          max-length = 40;
          separate-outputs = false;
        };

        "ext/workspaces" = {
          format = "{icon}";
          ignore-hidden = false;
          on-click = "activate";
          sort-by-id = true;
        };

        "dwl/tags" = {
          num-tags = 9;
        };

        "dwl/window" = {
          format = "[{layout}]{title}";
        };

        tray = {
          spacing = 10;
        };

        clock = {
          format-alt = "{:%Y-%m-%d}";
        };

        cpu = {
          format = "CPU: {usage}%";
          tooltip = false;
        };

        memory = {
          format = "Mem: {used}GiB";
        };

        disk = {
          interval = 60;
          path = "/";
          format = "Disk: {free}";
        };

        battery = {
          states = {
            good = 95;
            warning = 30;
            critical = 15;
          };
          format = "Bat: {capacity}% {icon} {time}";
          format-plugged = "{capacity}% Ôá¶";
          format-alt = "Bat {capacity}%";
          format-time = "{H}:{M}";
          format-icons = [
            "ÔâÑ"
            "ÔâÉ"
            "ÔâÇ"
            "ÔâÅ"
            "ÔâÄ"
          ];
        };

        network = {
          format = "Online";
          format-disconnected = "Disconnected ‚ö†";
        };

        "custom/sep" = {
          format = "|";
          interval = "once";
          tooltip = false;
        };
      };
    };

    style =
      let
        palette = config.colorScheme.palette;
      in
      ''
        @define-color bg    #${palette.base00}; 
        @define-color fg    #${palette.base05}; 
        @define-color blk   #${palette.base01}; 
        @define-color red   #${palette.base08}; 
        @define-color grn   #${palette.base0B}; 
        @define-color ylw   #${palette.base0A}; 
        @define-color blu   #${palette.base0D}; 
        @define-color mag   #${palette.base0E}; 
        @define-color cyn   #${palette.base0C}; 
        @define-color brblk #${palette.base02}; 
        @define-color white #${palette.base06}; 

        * {
            font-family: "JetBrainsMono Nerd Font", monospace;
            font-size: 16px;
            font-weight: bold;
        }

        window#waybar {
            background-color: @bg;
            color: @fg;
        }

        #workspaces button {
            padding: 0 6px;
            color: @cyn;
            background: transparent;
            border-bottom: 3px solid @bg;
            border-radius: 0;
        }

        #workspaces button.active {
            color: @cyn;
            border-bottom: 3px solid @mag;
        }

        #workspaces button.empty {
            color: @white;
        }

        #workspaces button.empty.active {
            color: @cyn;
            border-bottom: 3px solid @mag;
        }

        #workspaces button.urgent {
            background-color: @red;
        }

        button:hover {
            background: inherit;
            box-shadow: inset 0 -3px @mag;
        }

        #clock,
        #custom-sep,
        #battery,
        #cpu,
        #memory,
        #disk,
        #network,
        #tray {
            padding: 0 8px;
            color: @white;
        }

        #custom-sep {
            color: @brblk;
        }

        #clock {
            color: @cyn;
            border-bottom: 4px solid @cyn;
        }

        #battery {
            color: @mag;
            border-bottom: 4px solid @mag;
        }

        #disk {
            color: @ylw;
            border-bottom: 4px solid @ylw;
        }

        #memory {
            color: @mag;
            border-bottom: 4px solid @mag;
        }

        #cpu {
            color: @grn;
            border-bottom: 4px solid @grn;
        }

        #network {
            color: @blu;
            border-bottom: 4px solid @blu;
        }

        #network.disconnected {
            background-color: @red;
        }

        #tray {
            background-color: @bg;
        }
      '';
  };
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/waybar.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/desktop/wallpapers.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  conf,
  helpers,
  wallpapers,
  ...
}:
let
  enable = helpers.hasIn "workspace" "wallpapers";
  wallpaper = wallpapers.${conf.wallpaperName} or wallpapers.backyard;
in
{
  config = lib.mkIf enable (
    lib.mkMerge [
      (lib.mkIf helpers.isWayland {
        home.packages = [ pkgs.swaybg ];

        systemd.user.services.swaybg-daemon = {
          Unit = {
            Description = "Swaybg Wallpaper Daemon";
            After = [ "graphical-session.target" ];
            PartOf = [ "graphical-session.target" ];
          };
          Service = {
            Type = "simple";
            ExecStart = "${pkgs.swaybg}/bin/swaybg -i ${wallpaper} -m fill";
            Restart = "on-failure";
            RestartSec = "3";
          };
          Install.WantedBy = [ "graphical-session.target" ];
        };
      })

      (lib.mkIf helpers.isX11 {
        home.packages = [ pkgs.feh ];

        systemd.user.services.feh-daemon = {
          Unit = {
            Description = "Feh Wallpaper Daemon";
            After = [ "graphical-session-pre.target" ];
          };
          Service = {
            Type = "oneshot";
            ExecStart = "${pkgs.feh}/bin/feh --bg-fill ${wallpaper}";
            RemainAfterExit = true;
            Restart = "on-failure";
            RestartSec = "3";
          };
          Install.WantedBy = [ "graphical-session.target" ];
        };
      })
    ]
  );
}

=================== END FILE ===================
File: ./modules/home-manager/desktop/wallpapers.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/icons.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  helpers,
  ...
}:
{
  config = lib.mkIf helpers.isWM {
    gtk = {
      enable = true;
      iconTheme = {
        name = "Tela-circle";
        package = pkgs.tela-circle-icon-theme;
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/theme/icons.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/qt.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  helpers,
  ...
}:
{
  config = lib.mkIf helpers.isWM {
    home.packages = with pkgs; [
      libsForQt5.qt5ct
      qt6ct
      adwaita-qt
      adwaita-qt6
    ];

    qt = {
      enable = true;
      platformTheme.name = "qt6ct";

      style = {
        name = "Adwaita-dark";
        package = pkgs.adwaita-qt6;
      };
    };

    # TODO –ü–ï–†–ï–ú–ï–°–¢–ò–¢–¨ –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    home.sessionVariables = {
      QT_QPA_PLATFORMTHEME = "qt6ct";
      QT_STYLE_OVERRIDE = "Adwaita-dark";
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/theme/qt.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/gtk.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  helpers,
  ...
}:
let
  cfg = {
    theme = {
      name = "adw-gtk3-dark";
      package = pkgs.adw-gtk3;
    };
    font = {
      name = "Inter";
      package = pkgs.inter;
      size = 11;
    };
  };
in
{
  config = lib.mkIf helpers.isWM {
    dconf = {
      enable = true;
      settings = {
        "org/gnome/desktop/interface" = {
          color-scheme = "prefer-dark";
        };
        "org/gnome/desktop/wm/preferences" = {
          button-layout = ":";
        };
        "org/nemo/preferences" = {
          ignore-view-metadata = true;
        };
        "org/nemo/icon-view" = {
          default-zoom-level = "larger";
        };
        "org/nemo/list-view" = {
          default-zoom-level = "larger";
        };
      };
    };

    gtk = {
      enable = true;

      font = {
        name = cfg.font.name;
        size = cfg.font.size;
        package = cfg.font.package;
      };

      theme = {
        name = cfg.theme.name;
        package = cfg.theme.package;
      };

      gtk3 = {
        extraConfig = {
          gtk-application-prefer-dark-theme = 1;
        };
      };
    };

    home.sessionVariables = {
      GTK_THEME = cfg.theme.name;
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/theme/gtk.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/colors/gtk.nix
Extension: .nix
================================================

{
  config,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "workspace" "themes";
  colors = config.colorScheme.palette;
in
{
  config = lib.mkIf enable {
    gtk = {
      gtk2.extraConfig = ''
        gtk-color-scheme = "bg_color:#${colors.base01}\nfg_color:#${colors.base05}\nselected_bg_color:#${colors.base0D}\nselected_fg_color:#${colors.base00}"
      '';
    };

    xdg.configFile."gtk-3.0/gtk.css".text = ''
      @define-color accent_color #${colors.base0D};
      @define-color accent_fg_color #${colors.base00};
      @define-color accent_bg_color #${colors.base0D};
      @define-color window_bg_color #${colors.base01};
      @define-color window_fg_color #${colors.base05};
      @define-color headerbar_bg_color #${colors.base01};
      @define-color headerbar_fg_color #${colors.base05};
      @define-color popover_bg_color #${colors.base01};
      @define-color popover_fg_color #${colors.base05};
      @define-color view_bg_color #${colors.base00};
      @define-color view_fg_color #${colors.base05};
      @define-color card_bg_color #${colors.base00};
      @define-color card_fg_color #${colors.base05};
      @define-color sidebar_bg_color #${colors.base01};
      @define-color sidebar_fg_color #${colors.base05};
      @define-color sidebar_border_color #${colors.base01};
      @define-color sidebar_backdrop_color #${colors.base01};

      @define-color destructive_bg_color #${colors.base08};
      @define-color destructive_fg_color #${colors.base00};
      @define-color success_bg_color #${colors.base0B};
      @define-color success_fg_color #${colors.base00};
      @define-color warning_bg_color #${colors.base0A};
      @define-color warning_fg_color #${colors.base00};
    '';

    xdg.configFile."gtk-4.0/gtk.css".text = ''
      @define-color accent_color #${colors.base0D};
      @define-color accent_fg_color #${colors.base00};
      @define-color accent_bg_color #${colors.base0D};
      @define-color window_bg_color #${colors.base01};
      @define-color window_fg_color #${colors.base05};
      @define-color headerbar_bg_color #${colors.base01};
      @define-color headerbar_fg_color #${colors.base05};
      @define-color popover_bg_color #${colors.base01};
      @define-color popover_fg_color #${colors.base05};
      @define-color view_bg_color #${colors.base00};
      @define-color view_fg_color #${colors.base05};
      @define-color card_bg_color #${colors.base00};
      @define-color card_fg_color #${colors.base05};
      @define-color sidebar_bg_color #${colors.base01};
      @define-color sidebar_fg_color #${colors.base05};
      @define-color sidebar_border_color #${colors.base01};
      @define-color sidebar_backdrop_color #${colors.base01};

      @define-color destructive_bg_color #${colors.base08};
      @define-color destructive_fg_color #${colors.base00};
      @define-color success_bg_color #${colors.base0B};
      @define-color success_fg_color #${colors.base00};
      @define-color warning_bg_color #${colors.base0A};
      @define-color warning_fg_color #${colors.base00};
    '';
  };
}

=================== END FILE ===================
File: ./modules/home-manager/theme/colors/gtk.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/colors/firefox.nix
Extension: .nix
================================================

{
  config,
  lib,
  conf,
  wallpapers,
  pkgs,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "workspace" "themes";
  colors = config.colorScheme.palette;
  wallpaper = wallpapers.${conf.wallpaperName} or wallpapers.backyard;
in
{
  config = lib.mkIf enable {
    home.packages = [
      pkgs.pywalfox-native
    ];

    programs.firefox = {
      nativeMessagingHosts = [ pkgs.pywalfox-native ];
    };

    home.file.".mozilla/native-messaging-hosts/pywalfox.json".text = builtins.toJSON {
      name = "pywalfox";
      description = "Pywalfox native messaging host";
      path = "${pkgs.pywalfox-native}/bin/pywalfox";
      type = "stdio";
      allowed_extensions = [ "pywalfox@frewacom.org" ];
    };

    home.file.".cache/wal/colors.json".text = builtins.toJSON {
      wallpaper = "${wallpaper}";
      alpha = "100";
      colors = {
        color0 = "#${colors.base00}";
        color1 = "#${colors.base08}";
        color2 = "#${colors.base0B}";
        color3 = "#${colors.base0A}";
        color4 = "#${colors.base0D}";
        color5 = "#${colors.base0E}";
        color6 = "#${colors.base0C}";
        color7 = "#${colors.base05}";
        color8 = "#${colors.base03}";
        color9 = "#${colors.base05}";
        color10 = "#${colors.base0B}";
        color11 = "#${colors.base0A}";
        color12 = "#${colors.base0D}";
        color13 = "#${colors.base0E}";
        color14 = "#${colors.base0C}";
        color15 = "#${colors.base07}";
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/theme/colors/firefox.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/colors/dunst.nix
Extension: .nix
================================================

{
  config,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "workspace" "themes";
  colors = config.colorScheme.palette;
in
{
  config = lib.mkIf enable {
    services.dunst.settings = {
      global = {
        frame_color = "#${colors.base0D}";
        separator_color = "#${colors.base0D}";
      };

      urgency_low = {
        background = "#${colors.base01}";
        foreground = "#${colors.base04}";
        frame_color = "#${colors.base03}";
      };

      urgency_normal = {
        background = "#${colors.base01}";
        foreground = "#${colors.base05}";
        frame_color = "#${colors.base0D}";
      };

      urgency_critical = {
        background = "#${colors.base01}";
        foreground = "#${colors.base05}";
        frame_color = "#${colors.base08}";
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/theme/colors/dunst.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/colors/hyprland.nix
Extension: .nix
================================================

{
  config,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "workspace" "themes";
  colors = config.colorScheme.palette;
in
{
  config = lib.mkIf enable {
    wayland.windowManager.hyprland.settings = {
      general = {
        "col.active_border" = "rgba(${colors.base0D}ee)";
        "col.inactive_border" = "rgba(${colors.base03}ee)";
      };

      misc = {
        background_color = "rgba(${colors.base00}ee)";
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/theme/colors/hyprland.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/colors/alacritty.nix
Extension: .nix
================================================

{
  config,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "workspace" "themes";
  colors = config.colorScheme.palette;
in
{
  config = lib.mkIf enable {
    programs.alacritty.settings = {
      colors = {
        primary = {
          background = "#${colors.base00}";
          foreground = "#${colors.base05}";
        };

        cursor = {
          text = "#${colors.base00}";
          cursor = "#${colors.base05}";
        };

        normal = {
          black = "#${colors.base00}";
          red = "#${colors.base08}";
          green = "#${colors.base0B}";
          yellow = "#${colors.base0A}";
          blue = "#${colors.base0D}";
          magenta = "#${colors.base0E}";
          cyan = "#${colors.base0C}";
          white = "#${colors.base05}";
        };

        bright = {
          black = "#${colors.base03}";
          red = "#${colors.base08}";
          green = "#${colors.base0B}";
          yellow = "#${colors.base0A}";
          blue = "#${colors.base0D}";
          magenta = "#${colors.base0E}";
          cyan = "#${colors.base0C}";
          white = "#${colors.base07}";
        };

        indexed_colors = [
          {
            index = 16;
            color = "#${colors.base09}";
          }
          {
            index = 17;
            color = "#${colors.base0F}";
          }
          {
            index = 18;
            color = "#${colors.base01}";
          }
          {
            index = 19;
            color = "#${colors.base02}";
          }
          {
            index = 20;
            color = "#${colors.base04}";
          }
          {
            index = 21;
            color = "#${colors.base06}";
          }
        ];
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/theme/colors/alacritty.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/colors/folders.nix
Extension: .nix
================================================

{
  config,
  pkgs,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "workspace" "themes";

  colorDetectionScript = pkgs.writeScript "papirus-color-finder.py" ''
    #!/usr/bin/env python3
    import sys

    PAPIRUS_COLORS = {
        'adwaita': '#93c0ea',
        'black': '#4f4f4f',
        'blue': '#5294e2',
        'bluegrey': '#607d8b',
        'breeze': '#57b8ec',
        'brown': '#ae8e6c',
        'carmine': '#a30002',
        'cyan': '#00bcd4',
        'darkcyan': '#45abb7',
        'deeporange': '#eb6637',
        'green': '#87b158',
        'grey': '#8e8e8e',
        'indigo': '#5c6bc0',
        'magenta': '#ca71df',
        'nordic': '#81a1c1',
        'orange': '#ee923a',
        'palebrown': '#d1bfae',
        'paleorange': '#eeca8f',
        'pink': '#f06292',
        'red': '#e25252',
        'teal': '#16a085',
        'violet': '#7e57c2',
        'white': '#e4e4e4',
        'yaru': '#676767',
        'yellow': '#f9bd30',
    }

    def hex_to_rgb(hex_color):
        hex_color = hex_color.lstrip('#')
        return tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))

    def color_distance(rgb1, rgb2):
        return sum((a - b) ** 2 for a, b in zip(rgb1, rgb2)) ** 0.5

    def find_closest_papirus_color(hex_input):
        rgb_input = hex_to_rgb(hex_input)
        min_distance = float('inf')
        closest_name = None

        for name, hex_val in PAPIRUS_COLORS.items():
            distance = color_distance(rgb_input, hex_to_rgb(hex_val))
            if distance < min_distance:
                min_distance = distance
                closest_name = name 
        return closest_name

    if __name__ == "__main__":
        if len(sys.argv) != 2:
            print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python3 papirus_color_finder.py '#94EBEB'")
            sys.exit(1)

        input_hex = sys.argv[1] if sys.argv[1].startswith('#') else '#' + sys.argv[1]
        name = find_closest_papirus_color(input_hex)
        print(name)
  '';
in
{
  config = lib.mkIf enable {
    home.packages = with pkgs; [
      papirus-folders
    ];

    home.activation = {
      papirusColorDetector = lib.hm.dag.entryAfter [ "writeBoundary" ] ''
        export PATH="${
          lib.makeBinPath (
            with pkgs;
            [
              gawk
              gtk3
            ]
          )
        }:$PATH"

        requested_hex="${config.colorScheme.palette.base0D or "5294e2"}"
        papirus_color=$(${pkgs.python3}/bin/python3 ${colorDetectionScript} "$requested_hex")
        ${pkgs.papirus-folders}/bin/papirus-folders -C "$papirus_color" --theme "Papirus-Dark"
        ${pkgs.gtk3}/bin/gtk-update-icon-cache -f "$HOME/.local/share/icons" 2>/dev/null || true
      '';
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/theme/colors/folders.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/colors/default.nix
Extension: .nix
================================================

{
  imports = [
    ./alacritty.nix
    ./dunst.nix
    #./firefox.nix
    ./gtk.nix
    ./hyprland.nix
    #./folders.nix
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/theme/colors/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/cursor.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  helpers,
  ...
}:
let
  cfg = {
    name = "Posy_Cursor_Black";
    package = pkgs.posy-cursors;
    size = 24;
  };
in
{
  config = lib.mkIf helpers.isWM {
    home.pointerCursor = {
      gtk.enable = true;
      x11.enable = true;
      name = cfg.name;
      package = cfg.package;
      size = cfg.size;
    };

    gtk.cursorTheme = {
      name = cfg.name;
      package = cfg.package;
      size = cfg.size;
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/theme/cursor.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/fonts.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  helpers,
  ...
}:
{
  home.packages =
    with pkgs;
    lib.mkIf helpers.isWM [
      nerd-fonts.fira-code
      nerd-fonts.hack
      montserrat
      inter
      roboto
      font-awesome
    ];
}

=================== END FILE ===================
File: ./modules/home-manager/theme/fonts.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/theme/default.nix
Extension: .nix
================================================

{
  imports = [
    ./gtk.nix
    ./qt.nix
    ./cursor.nix
    ./icons.nix
    ./fonts.nix
    ./colors
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/theme/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/default.nix
Extension: .nix
================================================

{
  imports = [
    ./base
    ./shell
    ./desktop
    ./programs
    ./services
    ./theme
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/shell/foot.nix
Extension: .nix
================================================

{
  config,
  pkgs,
  ...
}:
{
  programs.foot = {
    enable = true;
    package = pkgs.foot;

    settings = {
      main = {
        term = "xterm-256color";

        font = "JetBrainsMono Nerd Font:size=16";
        font-bold = "JetBrainsMono Nerd Font:style=Bold:size=16";
        font-italic = "JetBrainsMono Nerd Font:style=Italic:size=16";
        font-bold-italic = "JetBrainsMono Nerd Font:style=Bold Italic:size=16";

        pad = "15x15 center";
        dpi-aware = "yes";
        selection-target = "clipboard";
      };

      colors = {
        alpha = 0.95;

        # –ë–∞–∑–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ –∏–∑ colorscheme
        foreground = "${config.colorScheme.palette.base05}";
        background = "${config.colorScheme.palette.base00}";

        # –û–±—ã—á–Ω—ã–µ —Ü–≤–µ—Ç–∞ (regular)
        regular0 = "${config.colorScheme.palette.base00}"; # black
        regular1 = "${config.colorScheme.palette.base08}"; # red
        regular2 = "${config.colorScheme.palette.base0B}"; # green
        regular3 = "${config.colorScheme.palette.base0A}"; # yellow
        regular4 = "${config.colorScheme.palette.base0D}"; # blue
        regular5 = "${config.colorScheme.palette.base0E}"; # magenta
        regular6 = "${config.colorScheme.palette.base0C}"; # cyan
        regular7 = "${config.colorScheme.palette.base05}"; # white

        # –Ø—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞ (bright)
        bright0 = "${config.colorScheme.palette.base03}"; # bright black
        bright1 = "${config.colorScheme.palette.base08}"; # bright red
        bright2 = "${config.colorScheme.palette.base0B}"; # bright green
        bright3 = "${config.colorScheme.palette.base0A}"; # bright yellow
        bright4 = "${config.colorScheme.palette.base0D}"; # bright blue
        bright5 = "${config.colorScheme.palette.base0E}"; # bright magenta
        bright6 = "${config.colorScheme.palette.base0C}"; # bright cyan
        bright7 = "${config.colorScheme.palette.base07}"; # bright white

        # –¶–≤–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è
        selection-foreground = "${config.colorScheme.palette.base00}";
        selection-background = "${config.colorScheme.palette.base05}";
      };

      scrollback = {
        # –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        lines = 10000;

        # –ú–Ω–æ–∂–∏—Ç–µ–ª—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        multiplier = 3.0;
      };

      cursor = {
        # –°—Ç–∏–ª—å –∫—É—Ä—Å–æ—Ä–∞: block, beam, underline
        style = "block";

        # –ú–∏–≥–∞–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞
        blink = "no";

        # –ö—É—Ä—Å–æ—Ä –≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–º –æ–∫–Ω–µ: unchanged, hollow, none
        unfocused-style = "hollow";
      };

      mouse = {
        # –°–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ
        hide-when-typing = "yes";
      };

      mouse-bindings = {
        # –û—Ç–∫–ª—é—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π
        select-extend = "none";

        # –ù–∞–∑–Ω–∞—á–∞–µ–º –≤—Å—Ç–∞–≤–∫—É –Ω–∞ –ø—Ä–∞–≤—É—é –∫–Ω–æ–ø–∫—É
        # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å primary-paste –∏–ª–∏ clipboard-paste
        clipboard-paste = "BTN_RIGHT";

        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∏–≤—è–∑–∫–∏
        select-begin = "BTN_LEFT";
        select-begin-block = "Control+BTN_LEFT";
        select-word = "BTN_LEFT-2";

        # –°—Ä–µ–¥–Ω—è—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏–∑ primary selection
        primary-paste = "BTN_MIDDLE";
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/shell/foot.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/shell/tmux.nix
Extension: .nix
================================================

{ pkgs, ... }:
{
  programs.tmux = {
    enable = true;
    package = pkgs.tmux;

    terminal = "tmux-256color";
    prefix = "C-a";
    baseIndex = 1;
    keyMode = "vi";
    mouse = true;
    sensibleOnTop = true;

    plugins = with pkgs; [
      tmuxPlugins.sensible
      tmuxPlugins.vim-tmux-navigator
      {
        plugin = tmuxPlugins.catppuccin;
        extraConfig = ''
          set -g @catppuccin_flavour 'mocha'
          set -g @catppuccin_window_status_style "rounded"

          set -g status-right-length 100
          set -g status-left-length 100
          set -g status-left ""
          set -g status-right "#{E:@catppuccin_status_application}"
          set -agF status-right "#{E:@catppuccin_status_cpu}"
          set -ag status-right "#{E:@catppuccin_status_session}"
          set -ag status-right "#{E:@catppuccin_status_uptime}"
          set -agF status-right "#{E:@catppuccin_status_battery}"
        '';
      }
      {
        plugin = tmuxPlugins.resurrect;
        extraConfig = ''
          set -g @resurrect-capture-pane-contents 'on'
        '';
      }
      {
        plugin = tmuxPlugins.continuum;
        extraConfig = ''
          set -g @continuum-restore 'on'
        '';
      }
      tmuxPlugins.sessionist
    ];

    extraConfig = ''
      bind s choose-tree -sZ -O name

      unbind %
      bind | split-window -v
      unbind '"'
      bind - split-window -h

      unbind r
      bind r source-file ~/.config/tmux/tmux.conf \; display-message "Config reload

      bind -r j resize-pane -D 5
      bind -r k resize-pane -U 5
      bind -r l resize-pane -R 5
      bind -r h resize-pane -L 5
      bind -r m resize-pane -Z

      bind-key -T copy-mode-vi 'v' send -X begin-selection 
      bind-key -T copy-mode-vi 'y' send -X copy-selection 
      unbind -T copy-mode-vi MouseDragEnd1Pane
    '';
  };
}

=================== END FILE ===================
File: ./modules/home-manager/shell/tmux.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/shell/starship.nix
Extension: .nix
================================================

{ pkgs, ... }:
{
  programs.starship = {
    enable = true;
    package = pkgs.starship;

    settings = {
      add_newline = false;
      command_timeout = 1000;
      format = "$all$nix_shell$character";

      character = {
        success_symbol = "[‚ûú](bold cyan)";
        error_symbol = "[‚úó](bold red)";
      };

      directory = {
        truncation_length = 3;
        truncate_to_repo = true;
      };

      git_branch = {
        symbol = " ";
        style = "bold purple";
        format = "[$symbol$branch]($style) ";
      };

      git_status = {
        ahead = "‚á°\${count}";
        diverged = "‚áï‚á°\${ahead_count}‚á£\${behind_count}";
        behind = "‚á£\${count}";
        deleted = "x";
      };

      nix_shell = {
        symbol = " ";
        format = "[$symbol$state]($style) ";
        style = "bold blue";
      };

      cmd_duration = {
        min_time = 500;
        format = "took [$duration](bold yellow) ";
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/shell/starship.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/shell/default.nix
Extension: .nix
================================================

{
  imports = [
    ./bash.nix
    ./starship.nix
    ./tmux.nix
    ./foot.nix
  ];
}

=================== END FILE ===================
File: ./modules/home-manager/shell/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/shell/bash.nix
Extension: .nix
================================================

{ ... }:
{
  programs.bash = {
    enable = true;
    enableCompletion = true;

    shellAliases = {
      ns-desktop = "sudo nixos-rebuild switch --flake ~/nixos#desktop";
      ns-laptop = "sudo nixos-rebuild switch --flake ~/nixos#laptop";
      ns-server = "nixos-rebuild switch --flake ~/nixos#server --target-host user@185.223.169.86 --sudo";
      nc = "sudo nix-collect-garbage -d";
      hc = "nix-collect-garbage -d";
      gc = "git add . && git commit -m";
      gp = "git push -u origin main";
    };
  };
}

=================== END FILE ===================
File: ./modules/home-manager/shell/bash.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/containers/cassettes-site.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  conf,
  helpers,
  ...
}:

let
  enable = helpers.hasIn "services" "cassettes-site";
  projectPath = "/var/lib/cassette-site";
  jwtSecretFile = "/var/lib/cassette-secrets/jwt-secret";
in
{
  config = lib.mkIf enable {
    virtualisation.docker.enable = true;
    users.users."${conf.username}".extraGroups = [ "docker" ];

    networking.firewall.allowedTCPPorts = [ 8080 ];

    systemd.tmpfiles.rules = [
      "d ${projectPath} 0755 root root -"
      "d /var/lib/cassette-secrets 0700 root root -"
      "f ${jwtSecretFile} 0600 root root -"
    ];
    
    services.nginx.enable = false;
    services.caddy = {
      enable = true;
      
      virtualHosts.":8080" = {
        extraConfig = ''
          handle /api/* {
            reverse_proxy localhost:5000
          }
          
          handle {
            reverse_proxy localhost:3000
          }
        '';
      };
    };

    systemd.services.cassette-git-sync = {
      description = "Sync Cassette site from Git";
      wantedBy = [ "multi-user.target" ];
      after = [ "systemd-tmpfiles-setup.service" ];
      requires = [ "systemd-tmpfiles-setup.service" ];
      path = [ pkgs.git pkgs.coreutils pkgs.bash ];
      serviceConfig = {
        Type = "oneshot";
        RemainAfterExit = true;
      };
      script = ''
        set -e
        
        mkdir -p ${projectPath}
        chmod 755 ${projectPath}
        
        if [ -d ${projectPath}/.git ]; then
          cd ${projectPath}
          ${pkgs.git}/bin/git fetch origin
          ${pkgs.git}/bin/git reset --hard origin/main
          ${pkgs.git}/bin/git pull origin main
        else
          rm -rf ${projectPath}/*
          rm -rf ${projectPath}/.* 2>/dev/null || true
          cd ${projectPath}
          ${pkgs.git}/bin/git clone https://github.com/umokee/cassettes-site.git .
        fi
        
        chmod -R u+w ${projectPath}
      '';
    };

    systemd.services.cassette-jwt-init = {
      description = "Generate JWT secret for Cassette";
      wantedBy = [ "multi-user.target" ];
      after = [ "systemd-tmpfiles-setup.service" ];
      requires = [ "systemd-tmpfiles-setup.service" ];
      path = [ pkgs.openssl pkgs.coreutils ];
      serviceConfig = {
        Type = "oneshot";
        RemainAfterExit = true;
      };
      script = ''
        mkdir -p /var/lib/cassette-secrets
        chmod 700 /var/lib/cassette-secrets
        
        if [ ! -s ${jwtSecretFile} ]; then
          echo "JWT_SECRET=$(${pkgs.openssl}/bin/openssl rand -base64 32)" > ${jwtSecretFile}
          chmod 600 ${jwtSecretFile}
        fi
      '';
    };

    systemd.services.cassette-app = {
      description = "Cassette Docker Compose from Git";
      after = [
        "docker.service"
        "docker.socket"
        "cassette-git-sync.service"
        "cassette-jwt-init.service"
        "caddy.service"
      ];
      requires = [
        "docker.service"
        "cassette-git-sync.service"
        "cassette-jwt-init.service"
      ];
      wantedBy = [ "multi-user.target" ];
      path = [
        pkgs.docker
        pkgs.docker-compose
      ];
      serviceConfig = {
        Type = "oneshot";
        RemainAfterExit = true;
        WorkingDirectory = projectPath;
        EnvironmentFile = jwtSecretFile;
        ExecStart = "${pkgs.docker-compose}/bin/docker-compose up -d --build";
        ExecStop = "${pkgs.docker-compose}/bin/docker-compose down";
      };
      preStart = ''
        if [ ! -d ${projectPath} ]; then
          echo "Error: ${projectPath} does not exist"
          exit 1
        fi
        
        if [ ! -d ${projectPath}/.git ]; then
          echo "Error: ${projectPath} is not a git repository"
          exit 1
        fi
        
        cd ${projectPath}
        ${pkgs.docker-compose}/bin/docker-compose down 2>/dev/null || true
      '';
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/containers/cassettes-site.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/containers/virtualization.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  conf,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "virtual-machine";
in
{
  config = lib.mkIf enable {
    networking = {
      bridges.br0.interfaces = [ "enp4s0" ];
      interfaces.br0.ipv4.addresses = [
        {
          address = "192.168.1.100";
          prefixLength = 24;
        }
      ];
      defaultGateway = "192.168.1.1";
      nameservers = [
        "192.168.1.1"
        "8.8.8.8"
      ];
    };

    virtualisation.libvirtd = {
      enable = true;
      allowedBridges = [ "br0" ];

      qemu = {
        package = pkgs.qemu_kvm;
        runAsRoot = true;
        swtpm.enable = true;

        ovmf = {
          enable = true;
          packages = [ pkgs.OVMFFull.fd ];
        };

        verbatimConfig = ''
          namespaces = []
        '';
      };
    };

    users.users = lib.genAttrs [ conf.username ] (user: {
      extraGroups = [
        "libvirtd"
        "kvm"
      ];
    });

    environment.sessionVariables = {
      LIBVIRT_DEFAULT_URI = "qemu:///system";
    };

    environment.systemPackages = with pkgs; [
      virt-viewer
      spice
      spice-gtk
      spice-protocol
      win-virtio
      win-spice
    ];
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/containers/virtualization.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/containers/default.nix
Extension: .nix
================================================

{
  imports = [
    ./virtualization.nix
    ./podman.nix
    ./cassettes-site.nix
  ];
}

=================== END FILE ===================
File: ./modules/nixos/services/containers/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/containers/podman.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  conf,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "podman";
in
{
  config = lib.mkIf enable {
    virtualisation.podman = {
      enable = true;
      dockerCompat = true;
      defaultNetwork.settings.dns_enabled = true;
    };

    users.users.${conf.username}.extraGroups = [ "podman" ];

    environment.systemPackages = with pkgs; [
      podman
      podman-compose
    ];
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/containers/podman.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/network/fail2ban.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "fail2ban";
in
{
  config = lib.mkIf enable {
    services.fail2ban = {
      enable = true;

      maxretry = 3;
      bantime = "52w";

      bantime-increment = {
        enable = true;
        multipliers = "1 2 4 8 16 32 64";
        maxtime = "10000d";
        rndtime = "600";
      };

      jails = {
        sshd.settings = {
          enabled = true;
          filter = "sshd";
          port = "ssh";
          mode = "aggressive";
          findtime = "3600";
        };

        recidive = {
          settings = {
            enabled = true;
            filter = "recidive";
            logpath = "/var/log/fail2ban.log";
            action = "iptables-allports[name=recidive]";
            findtime = "86400";
            maxretry = 3;
          };
        };

        apache-auth = {
          settings = {
            enabled = false;
            filter = "apache-auth";
            logpath = "/var/log/httpd/*error.log";
            maxretry = 3;
            bantime = "7d";
          };
        };

        nginx-http-auth = {
          settings = {
            enabled = false;
            filter = "nginx-http-auth";
            logpath = "/var/log/nginx/error.log";
            maxretry = 3;
            bantime = "7d";
          };
        };

        nginx-4xx = {
          settings = {
            enabled = false;
            filter = "nginx-4xx";
            logpath = "/var/log/nginx/access.log";
            maxretry = 10;
            bantime = "1h";
            findtime = "300";
          };
        };

        nginx-botsearch = {
          settings = {
            enabled = false;
            filter = "nginx-botsearch";
            logpath = "/var/log/nginx/access.log";
            maxretry = 5;
            bantime = "24h";
          };
        };
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/network/fail2ban.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/network/x-ray.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "xray";
in
{
  config = lib.mkIf enable {
    services.xray = {
      enable = true;

      settings = {
        log = {
          loglevel = "warning";
        };
        inbounds = [
          {
            tag = "vless-in";
            listen = "0.0.0.0";
            port = 443;
            protocol = "vless";
            settings = {
              clients = [
                {
                  id = "2bb6e04c-e434-4065-bfde-3e92a4e926c2";
                  flow = "xtls-rprx-vision";
                }
                {
                  id = "fd539ebe-41ea-4e8d-af6a-ae58a5636ab4";
                  flow = "xtls-rprx-vision";
                }
              ];
              decryption = "none";
            };
            streamSettings = {
              network = "tcp";
              security = "reality";
              realitySettings = {
                show = false;
                dest = "github.com:443";
                xver = 0;
                serverNames = [
                  "www.github.com"
                  "github.com"
                ];
                privateKey = "SBE7KNctHSGVO4Yk5p0mP1IwS5qEd3xd_-4SjPh_iEQ";
                shortIds = [
                  "1d0702eb71b9b044"
                ];
              };
              tcpSettings = {
                acceptProxyProtocol = false;
                header = {
                  type = "none";
                };
              };
              sockopt = {
                tcpKeepAliveInterval = 30;
                tcpKeepAliveIdle = 300;
                tcpCongestion = "bbr";
                tcpNoDelay = true;
                tcpFastOpen = true;
                mark = 255;
              };
            };
            sniffing = {
              enabled = true;
              destOverride = [
                "http"
                "tls"
                "quic"
              ];
              routeOnly = true;
            };
          }
        ];
        outbounds = [
          {
            protocol = "freedom";
            tag = "DIRECT";
          }
          {
            protocol = "blackhole";
            tag = "BLOCK";
          }
        ];
        routing = {
          rules = [
            {
              ip = [ "geoip:private" ];
              outboundTag = "BLOCK";
              type = "field";
            }
            {
              protocol = "bittorrent";
              outboundTag = "BLOCK";
              type = "field";
            }
            {
              domain = [
                "geosite:category-gov-ru"
                "regexp:.*\\.ru$"
                "regexp:.*\\.—Ä—Ñ$"
                "regexp:.*\\.su$"
              ];
              outboundTag = "BLOCK";
              type = "field";
            }
            {
              ip = [ "geoip:ru" ];
              outboundTag = "BLOCK";
              type = "field";
            }
          ];
        };
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/network/x-ray.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/network/sing-box/config.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "sing-box";

  rule_sets = {
    antizapret = pkgs.fetchurl {
      url = "https://github.com/savely-krasovsky/antizapret-sing-box/releases/latest/download/antizapret.srs";
      sha256 = "sha256-rU9fW8VM+/hUrniQg9BBw7ZFMD+sY49GF4XTBdtnd64=";
    };
    refilter_domains = pkgs.fetchurl {
      url = "https://github.com/1andrevich/Re-filter-lists/releases/latest/download/ruleset-domain-refilter_domains.srs";
      sha256 = "sha256-wZJpqcz225XxFnXKs1kUAF+9UdcaDWQZWua5CQ4fSTw=";
    };
    refilter_ipsum = pkgs.fetchurl {
      url = "https://github.com/1andrevich/Re-filter-lists/releases/latest/download/ruleset-ip-refilter_ipsum.srs";
      sha256 = "sha256-Rt34UdnrYU5/kVak7PsNRq3BBY+A+DEPJtoFrrQI8Os=";
    };
    geoip-ru = pkgs.fetchurl {
      url = "https://cdn.jsdelivr.net/gh/SagerNet/sing-geoip@rule-set/geoip-ru.srs";
      sha256 = "sha256-pCwbEX/ltxaLTFgM26E6j1N4ANgl7isazbhTScewkw8=";
    };
  };

  singboxSettings = {
    log = {
      level = "warn";
      output = "box.log";
      timestamp = true;
    };
    experimental = {
      cache_file = {
        enabled = true;
        path = "cache.db";
      };
    };
    dns = {
      servers = [
        {
          type = "https";
          tag = "dns-proxy";
          server = "1.1.1.1";
          server_port = 443;
          path = "/dns-query";
          detour = "proxy";
        }
        {
          type = "https";
          tag = "dns-direct";
          server = "8.8.8.8";
          server_port = 443;
          path = "/dns-query";
        }
        {
          type = "local";
          tag = "dns-local";
          detour = "direct";
        }
      ];
      disable_cache = false;
      disable_expire = false;
      independent_cache = true;
      #strategy = "ipv4_only";
      final = "dns-direct";
      reverse_mapping = true;
      rules = [
        {
          query_type = [
            32
            33
          ];
          action = "reject";
        }
        {
          domain_suffix = ".lan";
          action = "reject";
        }
        {
          domain_suffix = [
            ".nixos.org"
            ".cachix.org"
          ];
          action = "route";
          server = "dns-direct";
        }
        {
          domain_regex = [
            "^(.+\\.)?twitch\\.tv$"
            "^(.+\\.)?ttvnw\\.net$"
            "^(.+\\.)?twitchcdn\\.net$"
            "^(.+\\.)?jtvnw\\.net$"

            "^(.+\\.)?sheets\\.google\\.com$"
            "^(.+\\.)?docs\\.google\\.com$"
            "^(.+\\.)?drive\\.google\\.com$"
            "^(.+\\.)?accounts\\.google\\.com$"
            "^(.+\\.)?apis\\.google\\.com$"
            "^(.+\\.)?googleapis\\.com$"
            "^(.+\\.)?googleusercontent\\.com$"
            "^(.+\\.)?gstatic\\.com$"
            "^(.+\\.)?vercel\\.com$"
            "^(.+\\.)?v0\\.app$"
          ];
          action = "route";
          server = "dns-proxy";
        }
        {
          rule_set = [
            "antizapret"
            "refilter_domains"
          ];
          action = "route";
          server = "dns-proxy";
        }
      ];
    };
    inbounds = [
      {
        type = "tun";
        tag = "tun-in";
        interface_name = "nekoray-tun";
        address = [ "172.19.0.1/28" ];
        mtu = 1500;
        auto_route = true;
        strict_route = true;
        sniff = true;
        stack = "system";
      }
      {
        type = "socks";
        tag = "socks";
        listen = "127.0.0.1";
        listen_port = 9050;
        sniff = true;
      }
    ];
    outbounds = [
      {
        type = "vless";
        tag = "proxy";
        server = "185.223.169.86";
        server_port = 443;
        uuid = "2bb6e04c-e434-4065-bfde-3e92a4e926c2";
        flow = "xtls-rprx-vision";
        tls = {
          enabled = true;
          server_name = "github.com";
          reality = {
            enabled = true;
            public_key = "naGPegUP-BSqpa5Nxw4q8-4vvGrvc1gOlZmc_c6VChA";
            short_id = "1d0702eb71b9b044";
          };
          utls = {
            enabled = true;
            fingerprint = "chrome";
          };
        };
      }
      {
        type = "direct";
        tag = "direct";
      }
    ];
    route = {
      default_domain_resolver = {
        server = "dns-direct";
      };
      auto_detect_interface = true;
      final = "direct";
      rules = [
        {
          protocol = "dns";
          action = "hijack-dns";
        }
        {
          process_path_regex = [
            "/nix/store/[^/]*/share/mullvad-browser/mullvadbrowser"
          ];
          outbound = "proxy";
        }
        {
          domain_suffix = [
            ".nixos.org"
            ".cachix.org"
            "cache.nixos.org"
            "nix-community.cachix.org"
          ];
          outbound = "direct";
        }
        {
          ip_is_private = true;
          outbound = "direct";
        }
        {
          ip_cidr = [
            "224.0.0.0/3"
            "ff00::/8"
          ];
          action = "reject";
        }
        {
          source_ip_cidr = [
            "224.0.0.0/3"
            "ff00::/8"
          ];
          action = "reject";
        }
        {
          network = "udp";
          port = [
            21
            23
            135
            137
            138
            139
            445
            3306
            3389
            5353
          ];
          action = "reject";
        }
        {
          inbound = [ "socks" ];
          outbound = "proxy";
        }
        {
          rule_set = [ "geoip-ru" ];
          outbound = "direct";
        }
        {
          domain_regex = [
            "^(.+\\.)?twitch\\.tv$"
            "^(.+\\.)?ttvnw\\.net$"
            "^(.+\\.)?twitchcdn\\.net$"
            "^(.+\\.)?jtvnw\\.net$"

            "^(.+\\.)?sheets\\.google\\.com$"
            "^(.+\\.)?forms\\.google\\.com$"
            "^(.+\\.)?docs\\.google\\.com$"
            "^(.+\\.)?drive\\.google\\.com$"
            "^(.+\\.)?accounts\\.google\\.com$"
            "^(.+\\.)?apis\\.google\\.com$"
            "^(.+\\.)?googleapis\\.com$"
            "^(.+\\.)?googleusercontent\\.com$"
            "^(.+\\.)?gstatic\\.com$"
            "^(.+\\.)?gnusenpai\\.net$"
            "^(.+\\.)?typingstudy\\.com$"
            "^(.+\\.)?typingclub\\.com$"
            "^(.+\\.)?typing\\.com$"
            "^(.+\\.)?penpot\\.app$"
            "^(.+\\.)?diagrams\\.net$"
            "^(.+\\.)?draw\\.io$"
            "^(.+\\.)?creately\\.com$"
            "^(.+\\.)?yworks\\.com$"
            "^(.+\\.)?whimsical\\.com$"
          ];
          outbound = "proxy";
        }
        {
          rule_set = [
            "antizapret"
            "refilter_domains"
            "refilter_ipsum"
          ];
          outbound = "proxy";
        }
      ];
      rule_set = [
        {
          tag = "antizapret";
          type = "local";
          format = "binary";
          path = "${rule_sets.antizapret}";
        }
        {
          tag = "refilter_domains";
          type = "local";
          format = "binary";
          path = "${rule_sets.refilter_domains}";
        }
        {
          tag = "refilter_ipsum";
          type = "local";
          format = "binary";
          path = "${rule_sets.refilter_ipsum}";
        }
        {
          tag = "geoip-ru";
          type = "local";
          format = "binary";
          path = "${rule_sets.geoip-ru}";
        }
      ];
    };
  };
in
{
  config = lib.mkIf enable {
    environment.etc."sing-box-config.json".text = builtins.toJSON singboxSettings;
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/network/sing-box/config.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/network/sing-box/default.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "sing-box";
in
{
  imports = [
    ./config.nix
  ];

  config = lib.mkIf enable {
    environment.systemPackages = [ pkgs.sing-box ];
    networking.firewall.trustedInterfaces = [ "nekoray-tun" ];

    systemd.services.singbox-wrapper = {
      description = "Singbox Wrapper Service";
      wantedBy = [ ];
      after = [ "network.target" ];

      restartIfChanged = false;
      stopIfChanged = true;

      serviceConfig = {
        ExecStart = "${pkgs.sing-box}/bin/sing-box run -c /etc/sing-box-config.json";
        Restart = "on-failure";
        RestartSec = 5;
        StandardOutput = "journal";
        StandardError = "journal";

        KillSignal = "SIGTERM";
        TimeoutStopSec = "10s";
        KillMode = "mixed";

        AmbientCapabilities = "CAP_NET_ADMIN CAP_NET_BIND_SERVICE";
        CapabilityBoundingSet = "CAP_NET_ADMIN CAP_NET_BIND_SERVICE";

        ExecStopPost = "${pkgs.iproute2}/bin/ip link delete nekoray-tun || true";
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/network/sing-box/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/network/default.nix
Extension: .nix
================================================

{
  imports = [
    ./x-ray.nix
    ./sing-box
    ./fail2ban.nix
  ];
}

=================== END FILE ===================
File: ./modules/nixos/services/network/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/database/postgresql.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "postgresql";

  postgresConfig = "/home/user/postgresql/pg_config";

  postgresqlConf = ''
    listen_addresses = '*'
    port = 5432
    max_connections = 100
    shared_buffers = 256MB
    effective_cache_size = 1GB
    maintenance_work_mem = 64MB
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB
    work_mem = 4MB
    min_wal_size = 2GB
    max_wal_size = 8GB
    log_min_duration_statement = 1000
    log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    log_checkpoints = on
    log_connections = on
    log_disconnections = on
    log_lock_waits = on
    data_directory = '/var/lib/postgresql/data'
    wal_level = replica
    max_wal_senders = 3
    max_replication_slots = 3
  '';

  pgHbaConf = ''
    local   all             all                                     trust
    host    all             all             127.0.0.1/32            md5
    host    all             all             ::1/128                 md5
    host    all             all             0.0.0.0/0               md5
  '';

  setupScript = pkgs.writeShellScript "postgres-setup" ''
    set -e
    mkdir -p ${postgresConfig}
    
    if [ ! -f ${postgresConfig}/postgresql.conf ]; then
      cat > ${postgresConfig}/postgresql.conf << 'CONF'
    ${postgresqlConf}
    CONF
    fi
    
    if [ ! -f ${postgresConfig}/pg_hba.conf ]; then
      cat > ${postgresConfig}/pg_hba.conf << 'CONF'
    ${pgHbaConf}
    CONF
    fi
    
    
  '';
in
{
  config = lib.mkIf enable {
    environment.etc."containers/policy.json" = {
      text = builtins.toJSON {
        default = [
          {
            type = "insecureAcceptAnything";
          }
        ];
      };
      mode = "0644";
    };

    systemd.services.postgres-podman = {
      description = "PostgreSQL 16 container via Podman";
      wants = [ "network.target" ];
      after = [ "network.target" ];

      serviceConfig = {
        Restart = "on-failure";
        RestartSec = "10";
        User = "root";
        Type = "simple";
        TimeoutStopSec = "30";

        ExecStartPre = [
          "${pkgs.coreutils}/bin/mkdir -p ${postgresConfig}"
          "${setupScript}"
          "-${pkgs.podman}/bin/podman rm -f postgres"
        ];

        ExecStart = ''
          ${pkgs.podman}/bin/podman run \
            --name postgres \
            --replace \
            -e POSTGRES_PASSWORD=11 \
            -v ${postgresConfig}/postgresql.conf:/etc/postgresql/postgresql.conf:ro \
            -v ${postgresConfig}/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro \
            -p 5432:5432 \
            docker.io/library/postgres:16 \
            -c config_file=/etc/postgresql/postgresql.conf \
            -c hba_file=/etc/postgresql/pg_hba.conf
        '';

        ExecStop = "${pkgs.podman}/bin/podman stop -t 30 postgres";
        ExecStopPost = "-${pkgs.podman}/bin/podman rm -f postgres";
        KillMode = "control-group";
      };

      wantedBy = [ "multi-user.target" ];
    };

    environment.systemPackages = with pkgs; [
      postgresql
      pgadmin4-desktopmode
      podman
    ];

    networking.firewall.allowedTCPPorts = [ 5432 ];
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/database/postgresql.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/database/ms-sql.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "ms-sql";
in
{
  config = lib.mkIf enable {
    virtualisation.docker.enable = true;
    virtualisation.oci-containers.backend = "docker";

    systemd.tmpfiles.rules = [
      "d /var/lib/mssql 0755 10001 10001 -"
    ];

    virtualisation.oci-containers.containers.mssql = {
      image = "mcr.microsoft.com/mssql/server:2022-latest";

      environment = {
        ACCEPT_EULA = "Y";
        MSSQL_SA_PASSWORD = "Password!11!";
        MSSQL_PID = "Developer";
      };

      ports = [ "1433:1433" ];
      volumes = [ "/var/lib/mssql:/var/opt/mssql" ];
      extraOptions = [ "--hostname=mssql-server" ];
    };

    environment.systemPackages = with pkgs; [
      sqlcmd
    ];

    networking.firewall.allowedTCPPorts = [ 1433 ];
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/database/ms-sql.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/database/mongodb.nix
Extension: .nix
================================================

{ pkgs, ... }:

let
  projectPath = "/var/lib/mongo-gui";
  composeFile = "${projectPath}/docker-compose.yml";
  composeContent = ''
    version: "3.9"
    services:
      mongodb:
        image: mongo:latest
        container_name: mongodb
        ports:
          - "27017:27017"
        volumes:
          - mongo_data:/data/db
        restart: unless-stopped

      mongo-express:
        image: mongo-express:latest
        container_name: mongo-express
        ports:
          - "8081:8081"
        environment:
          ME_CONFIG_MONGODB_SERVER: mongodb
          ME_CONFIG_MONGODB_PORT: 27017
        depends_on:
          - mongodb
        restart: unless-stopped

    volumes:
      mongo_data:
  '';
in
{
  environment.systemPackages = with pkgs; [
    gtk3
    libx11
  ];

  virtualisation.docker.enable = true;

  systemd.tmpfiles.rules = [
    "d ${projectPath} 0755 root root -"
  ];

  system.activationScripts.mongoGuiComposeConfig = ''
    mkdir -p ${projectPath}
    echo '${composeContent}' > ${composeFile}
    chown root:root ${composeFile}
    chmod 644 ${composeFile}
  '';

  systemd.services.mongo-gui-app = {
    description = "MongoDB + Mongo GUI Compose";
    after = [ "docker.service" ];
    wantedBy = [ "multi-user.target" ];
    path = [
      pkgs.docker
      pkgs.docker-compose
    ];
    serviceConfig = {
      Type = "simple";
      WorkingDirectory = projectPath;
      ExecStart = "${pkgs.docker-compose}/bin/docker-compose up";
      ExecStop = "${pkgs.docker-compose}/bin/docker-compose down";
      Restart = "always";
      RestartSec = "10s";
    };
    preStart = ''
      cd ${projectPath}
      ${pkgs.docker-compose}/bin/docker-compose down 2>/dev/null || true
    '';
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/database/mongodb.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/database/default.nix
Extension: .nix
================================================

{
  imports = [
    ./mongodb.nix
    ./ms-sql.nix
    ./postgresql.nix
  ];
}

=================== END FILE ===================
File: ./modules/nixos/services/database/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/web/traefik.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "traefik";
in
{
  config = lib.mkIf enable {
    services.traefik = {
      enable = true;

      staticConfigOptions = {
        entryPoints = {
          web = {
            address = ":80";
          };
          websecure = {
            address = ":443";
          };
        };

        certificatesResolvers = {
          letsencrypt = {
            acme = {
              email = "hituaev@gmail.com";
              storage = "/var/lib/traefik/acme.json";
              httpChallenge = {
                entryPoint = "web";
              };
            };
          };
        };

        api = {
          dashboard = true;
        };

        log = {
          level = "INFO";
        };

        accessLog = { };
      };

      dynamicConfigOptions = {
        http = {
          routers = {
            domain-https = {
              rule = "Host(`umkcloud.ru`) || Host(`www.umkcloud.ru`)";
              entryPoints = [ "websecure" ];
              service = "github-redirect";
              middlewares = [ "redirect-github" ];
              tls = {
                certResolver = "letsencrypt";
              };
              priority = 100;
            };
          };
          services = {
            github-redirect = {
              loadBalancer = {
                servers = [
                  { url = "http://127.0.0.1:1"; }
                ];
              };
            };
          };
          middlewares = {
            redirect-github = {
              redirectRegex = {
                regex = ".*";
                replacement = "https://github.com";
                permanent = true;
              };
            };
          };
        };

        tcp = {
          routers = {
            vless-tcp = {
              rule = "HostSNI(`github.com`) || HostSNI(`www.github.com`)";
              entryPoints = [ "websecure" ];
              service = "xray-service";
              tls = {
                passthrough = true;
              };
              priority = 50;
            };
            fallback-tcp = {
              rule = "HostSNI(`*`)";
              entryPoints = [ "websecure" ];
              service = "github-service";
              tls = {
                passthrough = true;
              };
              priority = 1;
            };
          };

          services = {
            xray-service = {
              loadBalancer = {
                servers = [
                  { address = "127.0.0.1:8443"; }
                ];
              };
            };
            github-service = {
              loadBalancer = {
                servers = [
                  { address = "github.com:443"; }
                ];
              };
            };
          };
        };
      };
    };

    systemd.tmpfiles.rules = [
      "d /var/lib/traefik 0750 traefik traefik -"
      "f /var/lib/traefik/acme.json 0600 traefik traefik -"
    ];

    users.users.traefik = {
      isSystemUser = true;
      group = "traefik";
    };
    users.groups.traefik = { };
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/web/traefik.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/web/default.nix
Extension: .nix
================================================

{
  imports = [
    ./traefik.nix
  ];
}

=================== END FILE ===================
File: ./modules/nixos/services/web/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/default.nix
Extension: .nix
================================================

{
  imports = [
    ./network
    ./database
    ./containers
    ./web
    ./system
  ];
}

=================== END FILE ===================
File: ./modules/nixos/services/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/system/kanata.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "kanata";
in
{
  config = lib.mkIf enable {
    services.kanata = {
      enable = true;
      package = pkgs.kanata;

      keyboards = {
        default = {
          extraDefCfg = ''
            concurrent-tap-hold yes
            process-unmapped-keys true
          '';

          config = ''
(defsrc
  esc q w e r t enter
  lctrl a s d f g lalt
  lshift z x c v b
  super mo1 spc mo2 rshift
  
  p o i u y enter
  l k j h scolon ralt
  m n comma dot slash
  enter
)

;; ============ –ê–õ–ò–ê–°–´ - –†–£–°–°–ö–ò–ï –ë–£–ö–í–´ ============
(defalias
  –π –π
  —Ü —Ü
  —É —É
  –∫ –∫
  –µ –µ
  —Ñ —Ñ
  —ã —ã
  –≤ –≤
  –∞ –∞
  –ø –ø
  —è —è
  —á —á
  —Å —Å
  –º –º
  –∏ –∏
  –Ω –Ω
  –≥ –≥
  —à —à
  —â —â
  –∑ –∑
  —Ä —Ä
  –æ –æ
  –ª –ª
  –¥ –¥
  –∂ –∂
  —ç —ç
  —Ç —Ç
  —å —å
  –± –±
  —é —é
  —Ö —Ö
  
  sym (layer-while-held symbols)
)

;; ============ LAYER 0 - BASE (–†–£–°–°–ö–ò–ô COLEMAK) ============
(deflayer base
  esc @–π @—Ü @—É @–∫ @–µ ent
  lctrl @—Ñ @—ã @–≤ @–∞ @–ø lalt
  lshift @—è @—á @—Å @–º @–∏
  super @sym spc @sym rshift
  
  @–Ω @–≥ @—à @—â @–∑ ent
  @–ª @–¥ @–∂ @—Ä @–æ ralt
  @—Ç @—å @–± @—é @—Ö
  ent
)

;; ============ LAYER 1 - SYMBOLS (–°–ò–ú–í–û–õ–´) ============
(deflayer symbols
  esc ! @ # $ % _
  lctrl 1 2 3 4 5 lalt
  lshift 6 7 8 9 0
  super @sym spc @sym rshift
  
  ^ & * ( ) _
  - = [ ] bsls ralt
  _ ; : ' slash
  _
)
          '';
        };
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/system/kanata.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/system/file-management.nix
Extension: .nix
================================================

{ lib, helpers, ... }:
{
  config = lib.mkIf helpers.isWM {
    services = {
      tumbler.enable = true;
      gvfs.enable = true;
      udisks2.enable = true;
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/system/file-management.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/system/fstrim.nix
Extension: .nix
================================================

{ lib, helpers, ... }:
{
  config = lib.mkIf (helpers.isDesktop || helpers.isLaptop) {
    services.fstrim = {
      enable = true;
      interval = "daily";
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/system/fstrim.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/system/openssh.nix
Extension: .nix
================================================

{
  lib,
  conf,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "services" "openssh";

  authorizedKeys = [
    "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAII/gto5eMkM9Ghp5VScGT58ebz1VHCMhCpj8Hse4OjKI user@nixos-desktop"
  ];
in
{
  config = lib.mkIf enable {
    services.openssh = {
      enable = true;
      ports = [ 22 ];

      settings = {
        PermitRootLogin = if helpers.isServer then "prohibit-password" else "yes";
        PasswordAuthentication = if helpers.isServer then false else true;
        KbdInteractiveAuthentication = false;

        X11Forwarding = lib.mkIf helpers.isServer false;
        AllowTcpForwarding = lib.mkIf helpers.isServer "yes";
        AllowAgentForwarding = lib.mkIf helpers.isServer false;

        PubkeyAuthentication = true;
        AuthenticationMethods = if helpers.isServer then "publickey" else "publickey,password";

        ClientAliveInterval = 300;
        ClientAliveCountMax = 2;
        MaxAuthTries = 3;
        LoginGraceTime = 60;
      };

      extraConfig = lib.mkIf helpers.isServer ''
        AllowUsers user
        Protocol 2
        HostbasedAuthentication no
        IgnoreRhosts yes
        PermitEmptyPasswords no
      '';
    };

    users.users.${conf.username}.openssh.authorizedKeys.keys = authorizedKeys;
    users.users.root.openssh.authorizedKeys.keys = authorizedKeys;
  };
}

=================== END FILE ===================
File: ./modules/nixos/services/system/openssh.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/services/system/default.nix
Extension: .nix
================================================

{
  imports = [
    ./openssh.nix
    ./file-management.nix
    ./kanata.nix
    ./fstrim.nix
  ];
}

=================== END FILE ===================
File: ./modules/nixos/services/system/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/core/locale.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "base" "locale";

  timezone = "Asia/Vladivostok";
  locale = "en_US.UTF-8";
in
{
  config = lib.mkIf enable {
    time.timeZone = timezone;
    i18n.defaultLocale = locale;
    i18n.supportedLocales = [
      "ru_RU.UTF-8/UTF-8"
      "en_US.UTF-8/UTF-8"
    ];
    i18n.extraLocaleSettings = {
      LC_ADDRESS = locale;
      LC_IDENTIFICATION = locale;
      LC_MEASUREMENT = locale;
      LC_MONETARY = locale;
      LC_NAME = locale;
      LC_NUMERIC = locale;
      LC_PAPER = locale;
      LC_TELEPHONE = locale;
      LC_TIME = locale;
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/core/locale.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/core/users.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  conf,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "base" "users";
in
{
  config = lib.mkIf enable {
    users.users.${conf.username} = {
      isNormalUser = true;
      description = "Main user";
      extraGroups = [
        "wheel"
        "networkmanager"
        "input"
      ]
      ++ lib.optionals (helpers.hasIn "hardware" "sound") [
        "sound"
      ]
      ++
        lib.optionals
          (helpers.hasIn "hardware" [
            "nvidia"
            "amd"
          ])
          [
            "video"
            "render"
          ];
      shell = pkgs.bash;
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/core/users.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/core/boot.nix
Extension: .nix
================================================

{
  config,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "base" "boot";
in
{
  config = lib.mkIf enable {
    nixpkgs.overlays = [
      (self: super: {
        linuxPackages = super.linuxPackages // {
          kernel = super.linuxPackages.kernel.override {
            structuredExtraConfig = with lib.kernel; {
              HZ_1000 = yes;
              HZ = 1000;
              PREEMPT_FULL = yes;
              IOSCHED_BFQ = yes;
              DEFAULT_BFQ = yes;
              DEFAULT_IOSCHED = "bfq";
              V4L2_LOOPBACK = module;
              HID = yes;
            };
          };
        };
      })
    ];

    services.udev.extraRules = ''
      ACTION=="add|change", SUBSYSTEM=="block", ATTR{queue/scheduler}="bfq"
    '';

    boot.loader.grub = {
      enable = true;
      device = if helpers.isServer then "/dev/sda" else "nodev";
      efiSupport = !helpers.isServer;
      efiInstallAsRemovable = !helpers.isServer;
    };
    boot.loader.timeout = 3;

    boot = {
      tmp.cleanOnBoot = true;
      supportedFilesystems.zfs = lib.mkForce false;

      kernelParams =
        if builtins.elem "kvm-amd" config.boot.kernelModules then
          [
            "amd_pstate=active"
            "nosplit_lock_mitigate"
            "clearcpuid=514"
          ]
        else
          [ "nosplit_lock_mitigate" ]
          ++ [
            "quiet"
            "splash"
          ];

      kernel.sysctl = {
        "kernel.split_lock_mitigate" = 0;
        "vm.swappiness" = 10;
        "vm.vfs_cache_pressure" = 50;
        "vm.dirty_bytes" = 268435456;
        "vm.max_map_count" = 16777216;
        "vm.dirty_background_bytes" = 67108864;
        "vm.dirty_writeback_centisecs" = 1500;
        "kernel.nmi_watchdog" = 0;
        "kernel.unprivileged_userns_clone" = 1;
        "kernel.printk" = "3 3 3 3";
        "kernel.kptr_restrict" = 2;
        "kernel.kexec_load_disabled" = 1;
      };

      initrd.verbose = false;
      consoleLogLevel = 3;
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/core/boot.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/core/system.nix
Extension: .nix
================================================

{
  conf,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "base" "system";
in
{
  config = lib.mkMerge [
    (lib.mkIf enable {
      time.hardwareClockInLocalTime = true;

      hardware.graphics = {
        enable = true;
        enable32Bit = true;
      };

      zramSwap = {
        enable = true;
        algorithm = "zstd";
        memoryPercent = if helpers.isServer then 150 else 25;
        priority = 5;
      };

      nix = {
        settings = {
          trusted-users = [
            "root"
            conf.username
          ];
          auto-optimise-store = true;
          experimental-features = [
            "nix-command"
            "flakes"
          ];

          substituters = [
            "https://cache.nixos.org"
            "https://cache.nix-community.org"
            "https://arnoldcache.cachix.org"
          ];
          trusted-public-keys = [
            "cache.nixos.org-1:..."
            "cache.nix-community.org-1:..."
            "arnoldcache.cachix.org-1:..."
          ];
          fallback = true;
          max-jobs = "auto";
          cores = 0;

          show-trace = true;

          keep-outputs = false;
          keep-derivations = false;
        };

        gc = {
          automatic = true;
          dates = "weekly";
          options = "--delete-older-than 7d";
        };

        optimise = {
          automatic = true;
          dates = [ "weekly" ];
        };
      };

      documentation = {
        enable = false;
        nixos.enable = false;
        man.enable = false;
        doc.enable = false;
      };

      programs.nix-ld.enable = true;
    })

    (lib.mkIf helpers.isServer {
      services.xserver.enable = lib.mkForce false;

      services.journald.extraConfig = ''
        SystemMaxUse=500M
        MaxRetentionSec=1week
      '';
    })
  ];
}

=================== END FILE ===================
File: ./modules/nixos/core/system.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/core/packages.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  helpers,
  ...
}:
{
  environment.systemPackages =
    with pkgs;
    [
      coreutils
      util-linux
      shadow
      curl
      wget
      nano
      vim
      git

      pciutils
      lsof
      gawk

      gnutar
      gzip
      unzip
      xz
      zstd
      lz4
      bzip2
      libarchive
    ]
    ++ lib.optionals (!helpers.isServer) [
      libnotify
      usbutils
      upower
      home-manager
    ];
}

=================== END FILE ===================
File: ./modules/nixos/core/packages.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/core/fonts.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "base" "fonts";
in
{
  config = lib.mkIf enable {
    fonts = {
      packages = with pkgs; [
        vistafonts
        corefonts
        dejavu_fonts
        liberation_ttf
        noto-fonts
        noto-fonts-emoji
        nerd-fonts.jetbrains-mono
      ];

      fontconfig = {
        enable = true;
        antialias = true;
        hinting.enable = true;

        defaultFonts = {
          serif = [ "DejaVu Serif" ];
          sansSerif = [ "DejaVu Sans" ];
          monospace = [ "JetBrainsMono Nerd Font" ];
        };
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/core/fonts.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/core/default.nix
Extension: .nix
================================================

{
  imports = [
    ./boot.nix
    ./system.nix
    ./users.nix
    ./locale.nix
    ./security.nix
    ./network.nix
    ./packages.nix
    ./fonts.nix
  ];
}

=================== END FILE ===================
File: ./modules/nixos/core/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/core/network.nix
Extension: .nix
================================================

{
  lib,
  conf,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "base" "network";
in
{
  config = lib.mkIf enable {
    networking = {
      hostName = conf.hostname;
      networkmanager.enable = true;

      firewall = {
        enable = helpers.isServer;

        allowedTCPPorts = [
          22
          80
          443
        ];

        allowedUDPPorts = [ 443 ];

        allowPing = true;

        interfaces = {
          "lo" = {
            allowedTCPPorts = [ ];
            allowedUDPPorts = [ ];
          };
        };
      };
    };

    services.resolved = {
      enable = true;
      dnssec = "false";
      extraConfig = ''
        DNS=8.8.8.8 1.1.1.1
        FallbackDNS=8.8.4.4 1.0.0.1
      '';
    };

    boot.kernel.sysctl = {
      "net.ipv4.tcp_congestion_control" = "bbr";
      "net.core.default_qdisc" = "fq";

      "net.ipv4.tcp_fastopen" = 3;

      "net.ipv4.tcp_slow_start_after_idle" = 0;
      "net.ipv4.tcp_no_metrics_save" = 1;
      "net.ipv4.tcp_notsent_lowat" = 16384;

      "net.ipv4.tcp_keepalive_time" = 300;
      "net.ipv4.tcp_keepalive_intvl" = 30;
      "net.ipv4.tcp_keepalive_probes" = 3;

      "net.ipv4.tcp_mtu_probing" = 1;

      "net.ipv4.tcp_window_scaling" = 1;
      "net.ipv4.tcp_timestamps" = 1;
      "net.ipv4.tcp_sack" = 1;
      "net.ipv4.tcp_fack" = 1;

      "net.ipv4.tcp_ecn" = 1;

      "net.ipv6.conf.all.disable_ipv6" = 1;
      "net.ipv6.conf.default.disable_ipv6" = 1;

      "net.netfilter.nf_conntrack_max" = 262144;
      "net.netfilter.nf_conntrack_tcp_timeout_established" = 7200;
    }
    // lib.optionalAttrs helpers.isDesktop {
      "net.core.rmem_max" = 134217728; # 128MB
      "net.core.wmem_max" = 134217728; # 128MB
      "net.ipv4.tcp_rmem" = "4096 131072 134217728";
      "net.ipv4.tcp_wmem" = "4096 131072 134217728";
      "net.ipv4.udp_rmem_min" = 16384;
      "net.ipv4.udp_wmem_min" = 16384;

      "net.core.netdev_max_backlog" = 16384;
      "net.core.somaxconn" = 4096;

      "net.ipv4.tcp_low_latency" = 1;

      #"net.ipv4.ip_local_port_range" = "10000 65535";

      "net.ipv4.tcp_tw_reuse" = 1;
      "net.ipv4.tcp_fin_timeout" = 15;

      "net.ipv4.tcp_frto" = 2;
      "net.ipv4.tcp_moderate_rcvbuf" = 1;
    }
    // lib.optionalAttrs helpers.isServer {
      "net.ipv4.ip_forward" = 1;

      "net.core.rmem_max" = 268435456; # 256MB
      "net.core.wmem_max" = 268435456; # 256MB
      "net.ipv4.tcp_rmem" = "4096 131072 268435456";
      "net.ipv4.tcp_wmem" = "4096 131072 268435456";
      "net.ipv4.udp_rmem_min" = 32768;
      "net.ipv4.udp_wmem_min" = 32768;

      "net.core.netdev_max_backlog" = 65536;
      "net.core.somaxconn" = 65536;

      "net.ipv4.ip_local_port_range" = "1024 65535";
      "net.ipv4.tcp_max_syn_backlog" = 8192;

      "net.ipv4.tcp_syncookies" = 1;
      "net.ipv4.tcp_synack_retries" = 2;
      "net.ipv4.tcp_syn_retries" = 2;

      "net.ipv4.tcp_tw_reuse" = 1;
      "net.ipv4.tcp_fin_timeout" = 10;

      "net.ipv4.tcp_max_tw_buckets" = 2000000;
      "net.ipv4.tcp_tw_recycle" = 0;

      "net.ipv4.tcp_max_orphans" = 262144;

      "net.ipv4.tcp_rfc1337" = 1;
      "net.ipv4.icmp_echo_ignore_broadcasts" = 1;
      "net.ipv4.icmp_ignore_bogus_error_responses" = 1;

      "net.ipv4.tcp_mem" = "65536 131072 262144";
      "net.ipv4.udp_mem" = "65536 131072 262144";

      "fs.file-max" = 2097152;
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/core/network.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/core/security.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "base" "security";
in
{
  config = lib.mkIf enable {
    security.sudo = {
      enable = true;
      execWheelOnly = !helpers.isServer;
      wheelNeedsPassword = !helpers.isServer;
      extraConfig = ''
        Defaults timestamp_timeout=5
        Defaults lecture="never"
      '';
    };

    security.polkit.enable = true;

    security.pam.loginLimits = [
      {
        domain = "*";
        item = "nice";
        type = "soft";
        value = "-20";
      }
      {
        domain = "*";
        item = "nice";
        type = "hard";
        value = "-20";
      }
    ];
  };
}

=================== END FILE ===================
File: ./modules/nixos/core/security.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/hardware/sound.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "hardware" "sound";
in
{
  config = lib.mkIf enable {
    boot.kernelParams = [ "usbcore.autosuspend=-1" ];
    security.rtkit.enable = true;
    services.pipewire = {
      enable = true;
      jack.enable = true;
      pulse.enable = true;

      alsa = {
        enable = true;
        support32Bit = true;
      };

      extraConfig.pipewire."92-low-latency" = {
        "context.properties" = {
          "default.clock.rate" = 48000;
          "default.clock.quantum" = 256;
          "default.clock.min-quantum" = 256;
          "default.clock.max-quantum" = 256;
        };
      };

      wireplumber.extraConfig = {
        "10-disable-camera" = {
          "wireplumber.profiles" = {
            main = {
              "monitor.libcamera" = "disabled";
            };
          };
        };
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/hardware/sound.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/hardware/bluetooth.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "hardware" "bluetooth";
in
{
  config = lib.mkIf enable {
    hardware.bluetooth = {
      enable = true;
      powerOnBoot = true;
      package = pkgs.bluez;

      settings = {
        General = {
          Enable = "Source,Sink,Media,Socket";
          Experimental = true;
        };
      };
    };

    environment.systemPackages = with pkgs; [
      bluez-tools
    ];

    services.blueman.enable = true;
  };
}

=================== END FILE ===================
File: ./modules/nixos/hardware/bluetooth.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/hardware/peripherals.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  conf,
  pkgs,
  ...
}:
let
  enable = helpers.hasIn "hardware" "keyboard-mouse";

  colemakRu = ''
    partial alphanumeric_keys
    xkb_symbols "ru-custom" {
        name[Group1] = "Russian (Standard)";

        // –¶–∏—Ñ—Ä–æ–≤–æ–π —Ä—è–¥
        key <AE01> { [ 1, exclam ] };
        key <AE02> { [ 2, at ] };
        key <AE03> { [ 3, numbersign ] };
        key <AE04> { [ 4, dollar ] };
        key <AE05> { [ 5, percent ] };
        key <AE06> { [ 6, asciicircum ] };
        key <AE07> { [ 7, ampersand ] };
        key <AE08> { [ 8, asterisk ] };
        key <AE09> { [ 9, parenleft ] };
        key <AE10> { [ 0, parenright ] };
        key <AE11> { [ minus, underscore ] };
        key <AE12> { [ equal, plus ] };

        // –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥ (Q W E R T Y U I O P)
        key <AD01> { [ Cyrillic_shorti, Cyrillic_SHORTI ] };      // –ô –π
        key <AD02> { [ Cyrillic_tse, Cyrillic_TSE ] };            // –¶ —Ü
        key <AD03> { [ Cyrillic_u, Cyrillic_U ] };                // –£ —É
        key <AD04> { [ Cyrillic_ka, Cyrillic_KA ] };              // –ö –∫
        key <AD05> { [ Cyrillic_ie, Cyrillic_IE ] };              // –ï –µ
        key <AD06> { [ Cyrillic_en, Cyrillic_EN ] };              // –ù –Ω
        key <AD07> { [ Cyrillic_ghe, Cyrillic_GHE ] };            // –ì –≥
        key <AD08> { [ Cyrillic_sha, Cyrillic_SHA ] };            // –® —à
        key <AD09> { [ Cyrillic_shcha, Cyrillic_SHCHA ] };        // –© —â
        key <AD10> { [ Cyrillic_ze, Cyrillic_ZE ] };              // –ó –∑
        key <AD11> { [ bracketleft, braceleft ] };                // [ {
        key <AD12> { [ bracketright, braceright ] };              // ] }
        
        // –î–æ–º–∞—à–Ω–∏–π —Ä—è–¥ (A S D F G H J K L ;)
        key <AC01> { [ Cyrillic_ef, Cyrillic_EF ] };              // –§ —Ñ
        key <AC02> { [ Cyrillic_yeru, Cyrillic_YERU ] };          // –´ —ã
        key <AC03> { [ Cyrillic_ve, Cyrillic_VE ] };              // –í –≤
        key <AC04> { [ Cyrillic_a, Cyrillic_A ] };                // –ê –∞
        key <AC05> { [ Cyrillic_pe, Cyrillic_PE ] };              // –ü –ø
        key <AC06> { [ Cyrillic_er, Cyrillic_ER ] };              // –† —Ä
        key <AC07> { [ Cyrillic_o, Cyrillic_O ] };                // –û –æ
        key <AC08> { [ Cyrillic_el, Cyrillic_EL ] };              // –õ –ª
        key <AC09> { [ Cyrillic_de, Cyrillic_DE ] };              // –î –¥
        key <AC10> { [ semicolon, colon ] };                      // ; :
        key <AC11> { [ apostrophe, quotedbl ] };                  // ' "
        key <AC12> { [ backslash, bar ] };                        // \ |
        
        // –ù–∏–∂–Ω–∏–π —Ä—è–¥ (Z X C V B N M <)
        key <AB01> { [ Cyrillic_ya, Cyrillic_YA ] };              // –Ø —è
        key <AB02> { [ Cyrillic_che, Cyrillic_CHE ] };            // –ß —á
        key <AB03> { [ Cyrillic_es, Cyrillic_ES ] };              // –° —Å
        key <AB04> { [ Cyrillic_em, Cyrillic_EM ] };              // –ú –º
        key <AB05> { [ Cyrillic_i, Cyrillic_I ] };                // –ò –∏
        key <AB06> { [ Cyrillic_te, Cyrillic_TE ] };              // –¢ —Ç
        key <AB07> { [ Cyrillic_softsign, Cyrillic_hardsign ] };  // —å —ä
        key <AB08> { [ comma, less ] };                           // , <
        key <AB09> { [ period, greater ] };                       // . >
        key <AB10> { [ slash, question ] };                       // / ?

        key <FK13> { [ Cyrillic_ha, Cyrillic_HA ] };              // –• 
        key <FK14> { [ Cyrillic_yu, Cyrillic_YU ] };              // –Æ 
        key <FK15> { [ Cyrillic_e, Cyrillic_E ] };                // –≠ —ç
        key <FK16> { [ Cyrillic_be, Cyrillic_BE ] };              // –ë –±
        key <FK17> { [ Cyrillic_zhe, Cyrillic_ZHE ] };            // –ñ –∂
    };
  '';
in
{
  config = lib.mkIf enable {
    environment.systemPackages = with pkgs; [
      xkeyboard_config
    ];

    services.xserver.xkb = {
      layout = "us,ru-custom";
      variant = "";
      options = "grp:ctrl_shift_toggle";
      extraLayouts.ru-custom = {
        description = "Russian (Standard)";
        languages = [ "ru" "eng" ];
        symbolsFile = (pkgs.writeText "ru-custom" colemakRu);
      };
    };

    console.keyMap = lib.mkDefault (lib.head (lib.splitString "," "us"));

    services.libinput = {
      enable = true;
      mouse = {
        accelProfile = "adaptive";
        accelSpeed = "0.0";
      };

      touchpad = {
        naturalScrolling = true;
        tapping = true;
        clickMethod = "clickfinger";
      };
    };

    services.udev.extraRules = ''
      KERNEL=="hidraw*", SUBSYSTEM=="hidraw", ATTRS{serial}=="*vial:f64c2b3c*", MODE="0660", GROUP="input", TAG+="uaccess", TAG+="udev-acl"
    '';

    users.users.${conf.username}.extraGroups = [
      "plugdev"
      "uaccess"
    ];

    systemd.services.reload-libinput = {
      description = "Reload libinput after udev changes";
      wantedBy = [ "multi-user.target" ];
      after = [ "systemd-udevd.service" ];
      serviceConfig = {
        Type = "oneshot";
        ExecStart = "${pkgs.systemd}/bin/udevadm trigger --subsystem-match=input";
        RemainAfterExit = true;
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/hardware/peripherals.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/hardware/power.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "hardware" "power-management";

  laptopTlpSettings = {
    CPU_SCALING_GOVERNOR_ON_AC = "schedutil";
    CPU_SCALING_GOVERNOR_ON_BAT = "powersave";

    CPU_ENERGY_PERF_POLICY_ON_AC = "balance_power";
    CPU_ENERGY_PERF_POLICY_ON_BAT = "power";

    CPU_BOOST_ON_AC = 1;
    CPU_BOOST_ON_BAT = 0;

    CPU_MIN_PERF_ON_AC = 0;
    CPU_MAX_PERF_ON_AC = 90;
    CPU_MIN_PERF_ON_BAT = 0;
    CPU_MAX_PERF_ON_BAT = 40;

    STOP_CHARGE_THRESH_BAT0 = 0;

    WIFI_PWR_ON_AC = "off";
    WIFI_PWR_ON_BAT = "on";

    SOUND_POWER_SAVE_ON_AC = 10;
    SOUND_POWER_SAVE_ON_BAT = 1;

    USB_AUTOSUSPEND = 1;
    USB_BLACKLIST_BTUSB = 0;
    USB_BLACKLIST_PHONE = 0;
  };

  desktopTlpSettings = {
    CPU_SCALING_GOVERNOR_ON_AC = "performance";
    CPU_SCALING_GOVERNOR_ON_BAT = "performance";

    CPU_ENERGY_PERF_POLICY_ON_AC = "performance";
    CPU_ENERGY_PERF_POLICY_ON_BAT = "performance";

    CPU_BOOST_ON_AC = 1;
    CPU_BOOST_ON_BAT = 1;

    CPU_MIN_PERF_ON_AC = 0;
    CPU_MAX_PERF_ON_AC = 100;
    CPU_MIN_PERF_ON_BAT = 0;
    CPU_MAX_PERF_ON_BAT = 100;

    WIFI_PWR_ON_AC = "off";
    WIFI_PWR_ON_BAT = "off";

    SOUND_POWER_SAVE_ON_AC = 0;
    SOUND_POWER_SAVE_ON_BAT = 0;

    USB_AUTOSUSPEND = 0;
  };

  tlpSettings = if helpers.isLaptop then laptopTlpSettings else desktopTlpSettings;
in
{
  config = lib.mkIf enable (
    lib.mkMerge [
      {
        powerManagement = {
          enable = true;
          cpuFreqGovernor = if helpers.isLaptop then "schedutil" else "performance";
          powertop.enable = helpers.isLaptop;
        };

        environment.systemPackages = with pkgs; [
          powertop
          acpi
          tlp
        ];
      }

      {
        services.tlp = {
          enable = true;
          settings = tlpSettings;
        };

        services.auto-cpufreq.enable = false;
        services.power-profiles-daemon.enable = false;
      }
    ]
  );
}

=================== END FILE ===================
File: ./modules/nixos/hardware/power.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/hardware/amd.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "hardware" "amd";
in
{
  config = lib.mkIf enable {
    boot.kernelParams = [
      "amd_pstate=active"  # –∏–ª–∏ "guided" –¥–ª—è –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∏
      "amdgpu.dcdebugmask=0x10"
      "amd_pstate.shared_mem=1"  # –£–ª—É—á—à–∞–µ—Ç –æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö —á–∞—Å—Ç–æ—Ç
    ]
    ++ lib.optionals helpers.isLaptop [
      "processor.max_cstate=5"
      "pcie_aspm=force"  # –í–∫–ª—é—á–∞–µ—Ç ASPM –¥–ª—è PCI-e —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      "amd_s2idle=deep"  # –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –≤ suspend
    ];

    services.xserver.videoDrivers = [ "amdgpu" ];

    hardware = {
      cpu.amd.updateMicrocode = true;
      enableRedistributableFirmware = true;

      graphics = {
        enable = true;
        enable32Bit = true;

        extraPackages = with pkgs; [
          mesa
          vulkan-loader
          vulkan-validation-layers
        ];
      };
    };

    environment.sessionVariables = {
      MESA_LOADER_DRIVER_OVERRIDE = "radeonsi";
      LIBVA_DRIVER_NAME = "radeonsi";
      VDPAU_DRIVER = "radeonsi";
    };

    environment.systemPackages =
      with pkgs;
      [
        libva-utils
        vulkan-tools
        vdpauinfo
        clinfo
      ]
      ++ lib.optionals helpers.isLaptop [
        ryzenadj
        zenmonitor
      ];
  };
}

=================== END FILE ===================
File: ./modules/nixos/hardware/amd.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/hardware/intel.nix
Extension: .nix
================================================

{
  pkgs,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "hardware" "intel";
in
{
  config = lib.mkIf enable {
    hardware.cpu.intel.updateMicrocode = true;

    hardware.graphics = {
      enable = true;
      enable32Bit = true;

      extraPackages = with pkgs; [
        intel-gpu-tools
        intel-media-driver
        vaapiIntel
        vaapiVdpau
        libvdpau-va-gl
        libva
        vulkan-loader
        vulkan-validation-layers
      ];

      extraPackages32 = with pkgs; [
        intel-gpu-tools
        intel-media-driver
        vaapiIntel
        vaapiVdpau
        libvdpau-va-gl
        libva
      ];
    };

    environment.sessionVariables = lib.mkIf (!helpers.hasNvidia) {
      LIBVA_DRIVER_NAME = "iHD";
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/hardware/intel.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/hardware/nvidia.nix
Extension: .nix
================================================

{
  config,
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "hardware" "nvidia";
in
{
  config = lib.mkIf enable {
    boot.kernelParams = [
      "nvidia-drm.modeset=1"
    ];

    services.xserver.videoDrivers = [ "nvidia" ];

    hardware.nvidia = {
      package = config.boot.kernelPackages.nvidiaPackages.latest;
      open = true;

      nvidiaSettings = true;
      modesetting.enable = true;

      powerManagement.enable = false;
      powerManagement.finegrained = false;

      nvidiaPersistenced = false;
    };

    environment.sessionVariables = {
      GBM_BACKEND = "nvidia-drm";
      __GLX_VENDOR_LIBRARY_NAME = "nvidia";
      LIBVA_DRIVER_NAME = "nvidia";

      WLR_NO_HARDWARE_CURSORS = "1";
      ELECTRON_OZONE_PLATFORM_HINT = "auto";
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/hardware/nvidia.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/hardware/default.nix
Extension: .nix
================================================

{
  imports = [
    ./nvidia.nix
    ./intel.nix
    ./amd.nix
    ./sound.nix
    ./bluetooth.nix
    ./power.nix
    ./print.nix
    ./peripherals.nix
  ];
}

=================== END FILE ===================
File: ./modules/nixos/hardware/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/hardware/print.nix
Extension: .nix
================================================

{
  config,
  lib,
  pkgs,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "hardware" "print";
in
{
  config = lib.mkIf enable (
    let
      allUsers = builtins.attrNames config.users.users;
      normalUsers = builtins.filter (user: config.users.users.${user}.isNormalUser) allUsers;
    in
    {
      environment.systemPackages = with pkgs; [
        gutenprint
      ];

      services.printing = {
        enable = true;
        startWhenNeeded = true;
        drivers = with pkgs; [
          epson-201401w
        ];
      };

      services.avahi = {
        enable = false;
        nssmdns4 = true;
        openFirewall = true;
      };

      services.udev.packages = with pkgs; [
        sane-airscan
        utsushi
      ];

      hardware.sane = {
        enable = true;
        extraBackends = with pkgs; [
          sane-airscan
          epkowa
          utsushi
          epsonscan2
        ];
      };

      programs.system-config-printer.enable = true;

      users.groups.scanner.members = normalUsers;
      users.groups.lp.members = normalUsers;
    }
  );
}

=================== END FILE ===================
File: ./modules/nixos/hardware/print.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/desktop/gaming.nix
Extension: .nix
================================================

{
  lib,
  pkgs,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "programs" "gaming";
in
{
  config = lib.mkIf enable {
    environment.systemPackages = with pkgs; [
      (lutris.override {
        extraLibraries = p: [
          p.libadwaita
          p.gtk4
        ];
      })

      glxinfo
      heroic
      (bottles.override {
        removeWarningPopup = true;
      })
      vkd3d-proton
      dxvk
      joystickwake
      mangohud
      oversteer
      umu-launcher
      wineWowPackages.staging
      winetricks
      openrgb-with-all-plugins

      xorg.xrdb
    ];

    environment.sessionVariables = {
      STEAM_EXTRA_COMPAT_TOOLS_PATHS = "\${HOME}/.steam/root/compatibilitytools.d";
    };
    services.hardware.openrgb.enable = true;
    services.udev.extraRules = ''
      # USB
      ATTRS{name}=="Sony Interactive Entertainment Wireless Controller Touchpad", ENV{LIBINPUT_IGNORE_DEVICE}="1"
      ATTRS{name}=="Sony Interactive Entertainment DualSense Wireless Controller Touchpad", ENV{LIBINPUT_IGNORE_DEVICE}="1"
      # Bluetooth
      ATTRS{name}=="Wireless Controller Touchpad", ENV{LIBINPUT_IGNORE_DEVICE}="1"
      ATTRS{name}=="DualSense Wireless Controller Touchpad", ENV{LIBINPUT_IGNORE_DEVICE}="1"
    '';

    hardware.steam-hardware.enable = true;
    hardware.opentabletdriver.enable = true;

    programs.gamemode.enable = true;

    programs.gamescope = {
      enable = true;
      capSysNice = true;
    };

    programs.steam = {
      enable = true;
      gamescopeSession.enable = true;
      package = pkgs.steam.override {
        extraEnv = {
          OBS_VKCAPTURE = true;
        };
      };
      remotePlay.openFirewall = true;
      localNetworkGameTransfers.openFirewall = true;
      extraCompatPackages = with pkgs; [
        proton-ge-bin
        proton-cachyos
      ];
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/desktop/gaming.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/desktop/window-managers.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  ...
}:
{
  config = lib.mkMerge [
    (lib.mkIf helpers.isWayland {
      environment.sessionVariables = {
        NIXOS_OZONE_WL = "1";
        XDG_SESSION_TYPE = "wayland";

        QT_QPA_PLATFORMTHEME = "qt5ct";
        QT_AUTO_SCREEN_SCALE_FACTOR = "1";
        QT_QPA_PLATFORM = "wayland;xcb";
        QT_WAYLAND_FORCE_DPI = "140";
      };
    })

    (lib.mkIf helpers.isHyprland {
      programs.hyprland = {
        enable = true;
        withUWSM = true;
        xwayland.enable = true;
      };

      environment.sessionVariables = {
        XDG_CURRENT_DESKTOP = "Hyprland";
        XDG_SESSION_DESKTOP = "Hyprland";
      };
    })
  ];
}

=================== END FILE ===================
File: ./modules/nixos/desktop/window-managers.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/desktop/appimage.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "programs" "appimage";
in
{
  config = lib.mkIf enable {
    programs.appimage = {
      enable = true;
      binfmt = true;
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/desktop/appimage.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/desktop/display-manager.nix
Extension: .nix
================================================

{
  lib,
  helpers,
  ...
}:
let
  enable = helpers.hasIn "workspace" "display-manager";
in
{
  config = lib.mkIf enable {
    services.displayManager.ly = {
      enable = false;
      settings = {
        animation = "none";
        clock = "%c";
        bigclock = true;
        hide_borders = true;
        hide_f1_commands = true;
      };
    };
  };
}

=================== END FILE ===================
File: ./modules/nixos/desktop/display-manager.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/desktop/default.nix
Extension: .nix
================================================

{
  imports = [
    ./display-manager.nix
    ./window-managers.nix
    ./gaming.nix
    ./appimage.nix
  ];
}

=================== END FILE ===================
File: ./modules/nixos/desktop/default.nix
================================================


================== BEGIN FILE ==================
File: ./modules/nixos/default.nix
Extension: .nix
================================================

{
  imports = [
    ./core
    ./hardware
    ./desktop
    ./services
  ];
}

=================== END FILE ===================
File: ./modules/nixos/default.nix
================================================


================== BEGIN FILE ==================
File: ./hosts/server/disko.nix
Extension: .nix
================================================

{
  disko.devices = {
    disk = {
      main = {
        type = "disk";
        device = "/dev/sda";
        content = {
          type = "gpt";
          partitions = {
            boot = {
              size = "1M";
              type = "EF02";
            };
            ESP = {
              size = "512M";
              type = "EF00";
              content = {
                type = "filesystem";
                format = "vfat";
                mountpoint = "/boot";
              };
            };
            root = {
              size = "100%";
              content = {
                type = "filesystem";
                format = "ext4";
                mountpoint = "/";
                mountOptions = [
                  "defaults"
                ];
              };
            };
          };
        };
      };
    };
  };
}

=================== END FILE ===================
File: ./hosts/server/disko.nix
================================================


================== BEGIN FILE ==================
File: ./hosts/server/home.nix
Extension: .nix
================================================

{ conf, ... }:
{
  home = {
    username = conf.username;
    homeDirectory = "/home/${conf.username}";
    stateVersion = "25.05";
  };

  programs.home-manager.enable = true;
}

=================== END FILE ===================
File: ./hosts/server/home.nix
================================================


================== BEGIN FILE ==================
File: ./hosts/server/hardware-configuration.nix
Extension: .nix
================================================

# Do not modify this file!  It was generated by ‚Äònixos-generate-config‚Äô
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/profiles/qemu-guest.nix")
    ];

  boot.initrd.availableKernelModules = [ "ahci" "uhci_hcd" "virtio_pci" "virtio_scsi" "sd_mod" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  fileSystems."/" =
    { device = "/dev/disk/by-uuid/52fa1b9a-346b-4da5-9f48-90d0eee665ae";
      fsType = "ext4";
    };

  swapDevices = [ ];

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
}

=================== END FILE ===================
File: ./hosts/server/hardware-configuration.nix
================================================


================== BEGIN FILE ==================
File: ./hosts/server/configuration.nix
Extension: .nix
================================================

{ lib, ... }:
{
  imports = [
    ./hardware-configuration.nix
  ];

  services.dbus = {
    enable = true;
    implementation = "broker";
  };

  networking.useDHCP = lib.mkDefault true;
  system.stateVersion = "25.05";
}

=================== END FILE ===================
File: ./hosts/server/configuration.nix
================================================


================== BEGIN FILE ==================
File: ./hosts/desktop/disko.nix
Extension: .nix
================================================

{
  disko.devices = {
    disk = {
      main = {
        device = "/dev/nvme0n1";
        type = "disk";
        content = {
          type = "gpt";
          partitions = {
            ESP = {
              type = "EF00";
              size = "1G";
              content = {
                type = "filesystem";
                format = "vfat";
                mountpoint = "/boot";
              };
            };
            swap = {
              size = "4G";
              content = {
                type = "swap";
                resumeDevice = false;
              };
            };
            root = {
              size = "100%";
              content = {
                type = "filesystem";
                format = "ext4";
                mountpoint = "/";
              };
            };
          };
        };
      };
      data_btrfs = {
        device = "/dev/sda";
        type = "disk";
        content = {
          type = "gpt";
          partitions = {
            btrfs_partition = {
              size = "100%";
              content = {
                type = "filesystem";
                format = "btrfs";
                mountpoint = "/mnt/disk";
              };
            };
          };
        };
      };
      data_ext4 = {
        device = "/dev/sdb";
        type = "disk";
        content = {
          type = "gpt";
          partitions = {
            ext4_partition = {
              size = "100%";
              content = {
                type = "filesystem";
                format = "ext4";
                mountpoint = "/mnt/storage";
              };
            };
          };
        };
      };
    };
  };
}

=================== END FILE ===================
File: ./hosts/desktop/disko.nix
================================================


================== BEGIN FILE ==================
File: ./hosts/desktop/home.nix
Extension: .nix
================================================

{ conf, ... }:
{
  home = {
    username = conf.username;
    homeDirectory = "/home/${conf.username}";
    stateVersion = "25.05";
  };

  programs.home-manager.enable = true;
}

=================== END FILE ===================
File: ./hosts/desktop/home.nix
================================================


================== BEGIN FILE ==================
File: ./hosts/desktop/hardware-configuration.nix
Extension: .nix
================================================

# Do not modify this file!  It was generated by ‚Äònixos-generate-config‚Äô
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "xhci_pci" "ahci" "nvme" "usb_storage" "usbhid" "sd_mod" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  # Enables DHCP on each ethernet and wireless interface. In case of scripted networking
  # (the default) this is the recommended approach. When using systemd-networkd it's
  # still possible to use this option, but it's recommended to use it in conjunction
  # with explicit per-interface declarations with `networking.interfaces.<interface>.useDHCP`.
  networking.useDHCP = lib.mkDefault true;
  # networking.interfaces.enp4s0.useDHCP = lib.mkDefault true;
  # networking.interfaces.wlo1.useDHCP = lib.mkDefault true;

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}

=================== END FILE ===================
File: ./hosts/desktop/hardware-configuration.nix
================================================


================== BEGIN FILE ==================
File: ./hosts/desktop/configuration.nix
Extension: .nix
================================================

{ ... }:
{
  imports = [
    ./disko.nix
    ./hardware-configuration.nix
  ];

  services.dbus = {
    enable = true;
    implementation = "broker";
  };

  programs.dconf.enable = true;
  # programs.xfconf.enable = true;
  system.stateVersion = "25.05";
}

=================== END FILE ===================
File: ./hosts/desktop/configuration.nix
================================================


================== BEGIN FILE ==================
File: ./hosts/laptop/disko.nix
Extension: .nix
================================================

{
  disko.devices = {
    disk = {
      main = {
        device = "/dev/nvme0n1";
        type = "disk";
        content = {
          type = "gpt";
          partitions = {
            ESP = {
              type = "EF00";
              size = "1G";
              content = {
                type = "filesystem";
                format = "vfat";
                mountpoint = "/boot";
              };
            };
            swap = {
              size = "16G";
              content = {
                type = "swap";
                randomEncryption = true;
                resumeDevice = true;
              };
            };
            root = {
              size = "100%";
              content = {
                type = "filesystem";
                format = "btrfs";
                mountpoint = "/";
              };
            };
          };
        };
      };
    };
  };
}

=================== END FILE ===================
File: ./hosts/laptop/disko.nix
================================================


================== BEGIN FILE ==================
File: ./hosts/laptop/home.nix
Extension: .nix
================================================

{ conf, ... }:
{
  home = {
    username = conf.username;
    homeDirectory = "/home/${conf.username}";
    stateVersion = "25.05";
  };

  programs.home-manager.enable = true;
}

=================== END FILE ===================
File: ./hosts/laptop/home.nix
================================================


================== BEGIN FILE ==================
File: ./hosts/laptop/configuration.nix
Extension: .nix
================================================

{ ... }:
{
  imports = [
    ./disko.nix
    ./hardware-configuration.nix
  ];

  services.dbus = {
    enable = true;
    implementation = "broker";
  };

  programs.dconf.enable = true;
  # programs.xfconf.enable = true;
  system.stateVersion = "25.05";
}

=================== END FILE ===================
File: ./hosts/laptop/configuration.nix
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/init.lua
Extension: .lua
================================================

vim.g.mapleader = ' '
vim.g.maplocalleader = ' '
vim.g.have_nerd_font = false

-- –ó–∞–≥—Ä—É–∑–∫–∞ core –º–æ–¥—É–ª–µ–π
require('core')

-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ writable –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è treesitter
local parser_install_dir = vim.fn.stdpath('cache') .. '/treesitters'
vim.fn.mkdir(parser_install_dir, 'p')
vim.opt.runtimepath:prepend(parser_install_dir)

local lazypath = vim.fn.stdpath('data') .. '/lazy/lazy.nvim'
if not (vim.uv or vim.loop).fs_stat(lazypath) then
  local lazyrepo = 'https://github.com/folke/lazy.nvim.git'
  local out = vim.fn.system({ 'git', 'clone', '--filter=blob:none', '--branch=stable', lazyrepo, lazypath })
  if vim.v.shell_error ~= 0 then
    vim.error('Error cloning lazy.nvim:\n' .. out)
  end
end
vim.opt.rtp:prepend(lazypath)

-- –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤
require('lazy').setup('plugins', {
  performance = {
    reset_packpath = false,
    rtp = {
      reset = false,
    },
  },
  ui = {
    icons = vim.g.have_nerd_font and {} or {
      cmd = '‚åò',
      config = 'üõ†',
      event = 'üìÖ',
      ft = 'üìÇ',
      init = '‚öô',
      keys = 'üóù',
      plugin = 'üîå',
      runtime = 'üíª',
      require = 'üåô',
      source = 'üìÑ',
      start = 'üöÄ',
      task = 'üìå',
      lazy = 'üí§ ',
    },
  },
})

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/init.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/core/init.lua
Extension: .lua
================================================

require('core.options')
require('core.keymaps')
require('core.autocmds')

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/core/init.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/core/options.lua
Extension: .lua
================================================

-- [[ Setting options ]]
-- See `:help vim.o`

-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫
vim.o.number = true
vim.o.relativenumber = true

-- –ú—ã—à—å
vim.o.mouse = 'a'

-- –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∂–∏–º (—É–∂–µ –≤ statusline)
vim.o.showmode = false

-- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞ —Å –û–°
vim.schedule(function()
  vim.o.clipboard = 'unnamedplus'
end)

-- Break indent
vim.o.breakindent = true

-- –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–º–µ–Ω
vim.o.undofile = true

-- –ü–æ–∏—Å–∫ –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞
vim.o.ignorecase = true
vim.o.smartcase = true

-- Signcolumn
vim.o.signcolumn = 'yes'

-- –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
vim.o.updatetime = 250
vim.o.timeoutlen = 300

-- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ–∫–æ–Ω
vim.o.splitright = true
vim.o.splitbelow = true

-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
vim.o.list = true
vim.opt.listchars = { tab = '¬ª ', trail = '¬∑', nbsp = '‚ê£' }

-- Live preview –∑–∞–º–µ–Ω
vim.o.inccommand = 'split'

-- –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
vim.o.cursorline = true

-- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ —Å—Ç—Ä–æ–∫ —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É –æ—Ç –∫—É—Ä—Å–æ—Ä–∞
vim.o.scrolloff = 10

-- –î–∏–∞–ª–æ–≥ –ø—Ä–∏ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
vim.o.confirm = true

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/core/options.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/core/autocmds.lua
Extension: .lua
================================================

-- [[ Basic Autocommands ]]
-- See `:help lua-guide-autocommands`

-- –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞
vim.api.nvim_create_autocmd('TextYankPost', {
  desc = 'Highlight when yanking (copying) text',
  group = vim.api.nvim_create_augroup('kickstart-highlight-yank', { clear = true }),
  callback = function()
    vim.hl.on_yank()
  end,
})

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/core/autocmds.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/core/keymaps.lua
Extension: .lua
================================================

-- [[ Basic Keymaps ]]
-- See `:help vim.keymap.set()`

-- –û—á–∏—Å—Ç–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –ø–æ–∏—Å–∫–∞ –ø–æ Esc
vim.keymap.set('n', '<Esc>', '<cmd>nohlsearch<CR>')

-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
vim.keymap.set('n', '<leader>q', vim.diagnostic.setloclist, { desc = 'Open diagnostic [Q]uickfix list' })

-- –í—ã—Ö–æ–¥ –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
vim.keymap.set('t', '<Esc><Esc>', '<C-\\><C-n>', { desc = 'Exit terminal mode' })

-- TIP: Disable arrow keys in normal mode
-- vim.keymap.set('n', '<left>', '<cmd>echo "Use h to move!!"<CR>')
-- vim.keymap.set('n', '<right>', '<cmd>echo "Use l to move!!"<CR>')
-- vim.keymap.set('n', '<up>', '<cmd>echo "Use k to move!!"<CR>')
-- vim.keymap.set('n', '<down>', '<cmd>echo "Use j to move!!"<CR>')

-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏
vim.keymap.set('n', '<C-h>', '<C-w><C-h>', { desc = 'Move focus to the left window' })
vim.keymap.set('n', '<C-l>', '<C-w><C-l>', { desc = 'Move focus to the right window' })
vim.keymap.set('n', '<C-j>', '<C-w><C-j>', { desc = 'Move focus to the lower window' })
vim.keymap.set('n', '<C-k>', '<C-w><C-k>', { desc = 'Move focus to the upper window' })

-- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –æ–∫–æ–Ω
-- vim.keymap.set('n', '<C-S-h>', '<C-w>H', { desc = 'Move window to the left' })
-- vim.keymap.set('n', '<C-S-l>', '<C-w>L', { desc = 'Move window to the right' })
-- vim.keymap.set('n', '<C-S-j>', '<C-w>J', { desc = 'Move window to the lower' })
-- vim.keymap.set('n', '<C-S-k>', '<C-w>K', { desc = 'Move window to the upper' })

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/core/keymaps.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/treesitter.lua
Extension: .lua
================================================

return {
  {
    'nvim-treesitter/nvim-treesitter',
    build = ':TSUpdate',
    main = 'nvim-treesitter.configs',
    opts = {
      -- lazy.nvim —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –ø–∞—Ä—Å–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      ensure_installed = {
        'bash', 'c', 'diff', 'html', 'lua', 'luadoc',
        'markdown', 'markdown_inline', 'query', 'vim', 'vimdoc',
        'nix', 'javascript', 'typescript', 'python'
      },
      auto_install = true,
      
      -- Writable –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –ø–∞—Ä—Å–µ—Ä–æ–≤
      parser_install_dir = vim.fn.stdpath('cache') .. '/treesitters',
      
      highlight = {
        enable = true,
        additional_vim_regex_highlighting = { 'ruby' },
      },
      indent = { enable = true, disable = { 'ruby' } },
    },
  },
  {
    'nvim-treesitter/nvim-treesitter-textobjects',
    dependencies = { 'nvim-treesitter/nvim-treesitter' },
  },
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/treesitter.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/lint.lua
Extension: .lua
================================================

return {

  { -- Linting
    'mfussenegger/nvim-lint',
    event = { 'BufReadPre', 'BufNewFile' },
    config = function()
      local lint = require 'lint'
      lint.linters_by_ft = {
        markdown = { 'markdownlint' },
      }

      -- To allow other plugins to add linters to require('lint').linters_by_ft,
      -- instead set linters_by_ft like this:
      -- lint.linters_by_ft = lint.linters_by_ft or {}
      -- lint.linters_by_ft['markdown'] = { 'markdownlint' }
      --
      -- However, note that this will enable a set of default linters,
      -- which will cause errors unless these tools are available:
      -- {
      --   clojure = { "clj-kondo" },
      --   dockerfile = { "hadolint" },
      --   inko = { "inko" },
      --   janet = { "janet" },
      --   json = { "jsonlint" },
      --   markdown = { "vale" },
      --   rst = { "vale" },
      --   ruby = { "ruby" },
      --   terraform = { "tflint" },
      --   text = { "vale" }
      -- }
      --
      -- You can disable the default linters by setting their filetypes to nil:
      -- lint.linters_by_ft['clojure'] = nil
      -- lint.linters_by_ft['dockerfile'] = nil
      -- lint.linters_by_ft['inko'] = nil
      -- lint.linters_by_ft['janet'] = nil
      -- lint.linters_by_ft['json'] = nil
      -- lint.linters_by_ft['markdown'] = nil
      -- lint.linters_by_ft['rst'] = nil
      -- lint.linters_by_ft['ruby'] = nil
      -- lint.linters_by_ft['terraform'] = nil
      -- lint.linters_by_ft['text'] = nil

      -- Create autocommand which carries out the actual linting
      -- on the specified events.
      local lint_augroup = vim.api.nvim_create_augroup('lint', { clear = true })
      vim.api.nvim_create_autocmd({ 'BufEnter', 'BufWritePost', 'InsertLeave' }, {
        group = lint_augroup,
        callback = function()
          -- Only run the linter in buffers that you can modify in order to
          -- avoid superfluous noise, notably within the handy LSP pop-ups that
          -- describe the hovered symbol using Markdown.
          if vim.bo.modifiable then
            lint.try_lint()
          end
        end,
      })
    end,
  },
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/lint.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/formatting.lua
Extension: .lua
================================================

return {
  {
    'stevearc/conform.nvim',
    event = { 'BufWritePre' },
    cmd = { 'ConformInfo' },
    keys = {
      {
        '<leader>f',
        function()
          require('conform').format({ async = true, lsp_format = 'fallback' })
        end,
        mode = '',
        desc = '[F]ormat buffer',
      },
    },
    opts = {
      notify_on_error = false,
      format_on_save = function(bufnr)
        local disable_filetypes = { c = true, cpp = true }
        if disable_filetypes[vim.bo[bufnr].filetype] then
          return nil
        else
          return {
            timeout_ms = 500,
            lsp_format = 'fallback',
          }
        end
      end,
      formatters_by_ft = {
        lua = { 'stylua' },
      },
    },
  },
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/formatting.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/indent_line.lua
Extension: .lua
================================================

return {
  { -- Add indentation guides even on blank lines
    'lukas-reineke/indent-blankline.nvim',
    -- Enable `lukas-reineke/indent-blankline.nvim`
    -- See `:help ibl`
    main = 'ibl',
    opts = {},
  },
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/indent_line.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/autopairs.lua
Extension: .lua
================================================

-- autopairs
-- https://github.com/windwp/nvim-autopairs

return {
  'windwp/nvim-autopairs',
  event = 'InsertEnter',
  opts = {},
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/autopairs.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/neo-tree.lua
Extension: .lua
================================================

return {
  'nvim-neo-tree/neo-tree.nvim',
  version = '*',
  dependencies = {
    'nvim-lua/plenary.nvim',
    'MunifTanjim/nui.nvim',
    'nvim-tree/nvim-web-devicons',
  },
  lazy = false,
  keys = {
    { '<leader>e', '<cmd>Neotree toggle<CR>', desc = 'Toggle file explorer' },
    { '<leader>E', '<cmd>Neotree focus<CR>', desc = 'Focus file explorer' },
  },
  opts = {
    filesystem = {
      window = {
        mappings = {
          ['\\'] = 'close_window',
        },
      },
    },
  },
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/neo-tree.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/git.lua
Extension: .lua
================================================

return {
  -- Gitsigns
  {
    'lewis6991/gitsigns.nvim',
    opts = {
      signs = {
        add = { text = '+' },
        change = { text = '~' },
        delete = { text = '_' },
        topdelete = { text = '‚Äæ' },
        changedelete = { text = '~' },
      },
      on_attach = function(bufnr)
        local gitsigns = require 'gitsigns'

        local function map(mode, l, r, opts)
          opts = opts or {}
          opts.buffer = bufnr
          vim.keymap.set(mode, l, r, opts)
        end

        -- Navigation
        map('n', ']c', function()
          if vim.wo.diff then
            vim.cmd.normal { ']c', bang = true }
          else
            gitsigns.nav_hunk 'next'
          end
        end, { desc = 'Jump to next git [c]hange' })

        map('n', '[c', function()
          if vim.wo.diff then
            vim.cmd.normal { '[c', bang = true }
          else
            gitsigns.nav_hunk 'prev'
          end
        end, { desc = 'Jump to previous git [c]hange' })

        -- Actions
        -- visual mode
        map('v', '<leader>hs', function()
          gitsigns.stage_hunk { vim.fn.line '.', vim.fn.line 'v' }
        end, { desc = 'git [s]tage hunk' })
        map('v', '<leader>hr', function()
          gitsigns.reset_hunk { vim.fn.line '.', vim.fn.line 'v' }
        end, { desc = 'git [r]eset hunk' })
        
        -- normal mode
        map('n', '<leader>hs', gitsigns.stage_hunk, { desc = 'git [s]tage hunk' })
        map('n', '<leader>hr', gitsigns.reset_hunk, { desc = 'git [r]eset hunk' })
        map('n', '<leader>hS', gitsigns.stage_buffer, { desc = 'git [S]tage buffer' })
        map('n', '<leader>hu', gitsigns.stage_hunk, { desc = 'git [u]ndo stage hunk' })
        map('n', '<leader>hR', gitsigns.reset_buffer, { desc = 'git [R]eset buffer' })
        map('n', '<leader>hp', gitsigns.preview_hunk, { desc = 'git [p]review hunk' })
        map('n', '<leader>hb', gitsigns.blame_line, { desc = 'git [b]lame line' })
        map('n', '<leader>hd', gitsigns.diffthis, { desc = 'git [d]iff against index' })
        map('n', '<leader>hD', function()
          gitsigns.diffthis '@'
        end, { desc = 'git [D]iff against last commit' })
        -- Toggles
        map('n', '<leader>tb', gitsigns.toggle_current_line_blame, { desc = '[T]oggle git show [b]lame line' })
        map('n', '<leader>tD', gitsigns.preview_hunk_inline, { desc = '[T]oggle git show [D]eleted' })
      end,
    },
  },

  -- TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
  {
    'folke/todo-comments.nvim',
    event = 'VimEnter',
    dependencies = { 'nvim-lua/plenary.nvim' },
    opts = { signs = false },
  },
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/git.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/ui.lua
Extension: .lua
================================================

return {
  -- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç—Å—Ç—É–ø–æ–≤
  {
    'NMAC427/guess-indent.nvim',
    opts = {},
  },

  -- Which-key: –ø–æ–∫–∞–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–µ–π–º–∞–ø–æ–≤
  {
    'folke/which-key.nvim',
    event = 'VimEnter',
    opts = {
      delay = 0,
      icons = {
        mappings = vim.g.have_nerd_font,
        keys = vim.g.have_nerd_font and {} or {
          Up = '<Up> ',
          Down = '<Down> ',
          Left = '<Left> ',
          Right = '<Right> ',
          C = '<C-‚Ä¶> ',
          M = '<M-‚Ä¶> ',
          D = '<D-‚Ä¶> ',
          S = '<S-‚Ä¶> ',
          CR = '<CR> ',
          Esc = '<Esc> ',
          ScrollWheelDown = '<ScrollWheelDown> ',
          ScrollWheelUp = '<ScrollWheelUp> ',
          NL = '<NL> ',
          BS = '<BS> ',
          Space = '<Space> ',
          Tab = '<Tab> ',
          F1 = '<F1>',
          F2 = '<F2>',
          F3 = '<F3>',
          F4 = '<F4>',
          F5 = '<F5>',
          F6 = '<F6>',
          F7 = '<F7>',
          F8 = '<F8>',
          F9 = '<F9>',
          F10 = '<F10>',
          F11 = '<F11>',
          F12 = '<F12>',
        },
      },
      spec = {
        { '<leader>s', group = '[S]earch' },
        { '<leader>t', group = '[T]oggle' },
        { '<leader>h', group = 'Git [H]unk', mode = { 'n', 'v' } },
      },
    },
  },

  -- –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞
  {
    'folke/tokyonight.nvim',
    priority = 1000,
    config = function()
      require('tokyonight').setup({
        styles = {
          comments = { italic = false },
        },
      })
      vim.cmd.colorscheme('tokyonight-night')
    end,
  },

  -- Mini.nvim –º–æ–¥—É–ª–∏
  {
    'echasnovski/mini.nvim',
    config = function()
      -- Better Around/Inside textobjects
      require('mini.ai').setup({ n_lines = 500 })

      -- Add/delete/replace surroundings
      require('mini.surround').setup()

      -- Statusline
      local statusline = require('mini.statusline')
      statusline.setup({ use_icons = vim.g.have_nerd_font })

      statusline.section_location = function()
        return '%2l:%-2v'
      end
    end,
  },
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/ui.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/debug.lua
Extension: .lua
================================================

-- debug.lua
--
-- Shows how to use the DAP plugin to debug your code.
--
-- Primarily focused on configuring the debugger for Go, but can
-- be extended to other languages as well. That's why it's called
-- kickstart.nvim and not kitchen-sink.nvim ;)

return {
  -- NOTE: Yes, you can install new plugins here!
  'mfussenegger/nvim-dap',
  -- NOTE: And you can specify dependencies as well
  dependencies = {
    -- Creates a beautiful debugger UI
    'rcarriga/nvim-dap-ui',

    -- Required dependency for nvim-dap-ui
    'nvim-neotest/nvim-nio',

    -- Installs the debug adapters for you
    'mason-org/mason.nvim',
    'jay-babu/mason-nvim-dap.nvim',

    -- Add your own debuggers here
    'leoluz/nvim-dap-go',
  },
  keys = {
    -- Basic debugging keymaps, feel free to change to your liking!
    {
      '<F5>',
      function()
        require('dap').continue()
      end,
      desc = 'Debug: Start/Continue',
    },
    {
      '<F1>',
      function()
        require('dap').step_into()
      end,
      desc = 'Debug: Step Into',
    },
    {
      '<F2>',
      function()
        require('dap').step_over()
      end,
      desc = 'Debug: Step Over',
    },
    {
      '<F3>',
      function()
        require('dap').step_out()
      end,
      desc = 'Debug: Step Out',
    },
    {
      '<leader>b',
      function()
        require('dap').toggle_breakpoint()
      end,
      desc = 'Debug: Toggle Breakpoint',
    },
    {
      '<leader>B',
      function()
        require('dap').set_breakpoint(vim.fn.input 'Breakpoint condition: ')
      end,
      desc = 'Debug: Set Breakpoint',
    },
    -- Toggle to see last session result. Without this, you can't see session output in case of unhandled exception.
    {
      '<F7>',
      function()
        require('dapui').toggle()
      end,
      desc = 'Debug: See last session result.',
    },
  },
  config = function()
    local dap = require 'dap'
    local dapui = require 'dapui'

    require('mason-nvim-dap').setup {
      -- Makes a best effort to setup the various debuggers with
      -- reasonable debug configurations
      automatic_installation = true,

      -- You can provide additional configuration to the handlers,
      -- see mason-nvim-dap README for more information
      handlers = {},

      -- You'll need to check that you have the required things installed
      -- online, please don't ask me how to install them :)
      ensure_installed = {
        -- Update this to ensure that you have the debuggers for the langs you want
        'delve',
      },
    }

    -- Dap UI setup
    -- For more information, see |:help nvim-dap-ui|
    dapui.setup {
      -- Set icons to characters that are more likely to work in every terminal.
      --    Feel free to remove or use ones that you like more! :)
      --    Don't feel like these are good choices.
      icons = { expanded = '‚ñæ', collapsed = '‚ñ∏', current_frame = '*' },
      controls = {
        icons = {
          pause = '‚è∏',
          play = '‚ñ∂',
          step_into = '‚èé',
          step_over = '‚è≠',
          step_out = '‚èÆ',
          step_back = 'b',
          run_last = '‚ñ∂‚ñ∂',
          terminate = '‚èπ',
          disconnect = '‚èè',
        },
      },
    }

    -- Change breakpoint icons
    -- vim.api.nvim_set_hl(0, 'DapBreak', { fg = '#e51400' })
    -- vim.api.nvim_set_hl(0, 'DapStop', { fg = '#ffcc00' })
    -- local breakpoint_icons = vim.g.have_nerd_font
    --     and { Breakpoint = 'Ó©±', BreakpointCondition = 'Ó™ß', BreakpointRejected = 'ÓÆå', LogPoint = 'Ó™´', Stopped = 'ÓÆã' }
    --   or { Breakpoint = '‚óè', BreakpointCondition = '‚äú', BreakpointRejected = '‚äò', LogPoint = '‚óÜ', Stopped = '‚≠î' }
    -- for type, icon in pairs(breakpoint_icons) do
    --   local tp = 'Dap' .. type
    --   local hl = (type == 'Stopped') and 'DapStop' or 'DapBreak'
    --   vim.fn.sign_define(tp, { text = icon, texthl = hl, numhl = hl })
    -- end

    dap.listeners.after.event_initialized['dapui_config'] = dapui.open
    dap.listeners.before.event_terminated['dapui_config'] = dapui.close
    dap.listeners.before.event_exited['dapui_config'] = dapui.close

    -- Install golang specific config
    require('dap-go').setup {
      delve = {
        -- On Windows delve must be run attached or it crashes.
        -- See https://github.com/leoluz/nvim-dap-go/blob/main/README.md#configuring
        detached = vim.fn.has 'win32' == 0,
      },
    }
  end,
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/debug.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/telescope.lua
Extension: .lua
================================================

return {
  {
    'nvim-telescope/telescope.nvim',
    event = 'VimEnter',
    dependencies = {
      'nvim-lua/plenary.nvim',
      {
        'nvim-telescope/telescope-fzf-native.nvim',
        build = 'make',
        cond = function()
          return vim.fn.executable('make') == 1
        end,
      },
      { 'nvim-telescope/telescope-ui-select.nvim' },
      { 'nvim-tree/nvim-web-devicons', enabled = vim.g.have_nerd_font },
    },
    config = function()
      require('telescope').setup({
        extensions = {
          ['ui-select'] = {
            require('telescope.themes').get_dropdown(),
          },
        },
      })

      -- –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
      pcall(require('telescope').load_extension, 'fzf')
      pcall(require('telescope').load_extension, 'ui-select')

      -- –ö–µ–π–º–∞–ø—ã
      local builtin = require('telescope.builtin')
      vim.keymap.set('n', '<leader>sh', builtin.help_tags, { desc = '[S]earch [H]elp' })
      vim.keymap.set('n', '<leader>sk', builtin.keymaps, { desc = '[S]earch [K]eymaps' })
      vim.keymap.set('n', '<leader>sf', builtin.find_files, { desc = '[S]earch [F]iles' })
      vim.keymap.set('n', '<leader>ss', builtin.builtin, { desc = '[S]earch [S]elect Telescope' })
      vim.keymap.set('n', '<leader>sw', builtin.grep_string, { desc = '[S]earch current [W]ord' })
      vim.keymap.set('n', '<leader>sg', builtin.live_grep, { desc = '[S]earch by [G]rep' })
      vim.keymap.set('n', '<leader>sd', builtin.diagnostics, { desc = '[S]earch [D]iagnostics' })
      vim.keymap.set('n', '<leader>sr', builtin.resume, { desc = '[S]earch [R]esume' })
      vim.keymap.set('n', '<leader>s.', builtin.oldfiles, { desc = '[S]earch Recent Files (\".\" for repeat)' })
      vim.keymap.set('n', '<leader><leader>', builtin.buffers, { desc = '[ ] Find existing buffers' })

      vim.keymap.set('n', '<leader>/', function()
        builtin.current_buffer_fuzzy_find(require('telescope.themes').get_dropdown({
          winblend = 10,
          previewer = false,
        }))
      end, { desc = '[/] Fuzzily search in current buffer' })

      vim.keymap.set('n', '<leader>s/', function()
        builtin.live_grep({
          grep_open_files = true,
          prompt_title = 'Live Grep in Open Files',
        })
      end, { desc = '[S]earch [/] in Open Files' })

      vim.keymap.set('n', '<leader>sn', function()
        builtin.find_files({ cwd = vim.fn.stdpath('config') })
      end, { desc = '[S]earch [N]eovim files' })
    end,
  },
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/telescope.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/completion.lua
Extension: .lua
================================================

return {
  {
    'saghen/blink.cmp',
    event = 'VimEnter',
    version = '1.*',
    dependencies = {
      {
        'L3MON4D3/LuaSnip',
        version = '2.*',
        build = (function()
          if vim.fn.has('win32') == 1 or vim.fn.executable('make') == 0 then
            return
          end
          return 'make install_jsregexp'
        end)(),
        opts = {},
      },
      'folke/lazydev.nvim',
    },
    opts = {
      keymap = {
        preset = 'default',
      },
      appearance = {
        nerd_font_variant = 'mono',
      },
      completion = {
        documentation = { auto_show = false, auto_show_delay_ms = 500 },
      },
      sources = {
        default = { 'lsp', 'path', 'snippets', 'lazydev' },
        providers = {
          lazydev = { module = 'lazydev.integrations.blink', score_offset = 100 },
        },
      },
      snippets = { preset = 'luasnip' },
      fuzzy = { implementation = 'lua' },
      signature = { enabled = true },
    },
  },
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/completion.lua
================================================


================== BEGIN FILE ==================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/lsp.lua
Extension: .lua
================================================

return {
  {
    'folke/lazydev.nvim',
    ft = 'lua',
    opts = {
      library = {
        { path = '${3rd}/luv/library', words = { 'vim%.uv' } },
      },
    },
  },

  {
    'j-hui/fidget.nvim',
    opts = {},
  },

  {
    'neovim/nvim-lspconfig',
    dependencies = {
      'saghen/blink.cmp',
      'folke/lazydev.nvim',
      'j-hui/fidget.nvim',
    },
    config = function()
      -- –ê–≤—Ç–æ–∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ LSP
      vim.api.nvim_create_autocmd('LspAttach', {
        group = vim.api.nvim_create_augroup('kickstart-lsp-attach', { clear = true }),
        callback = function(event)
          local map = function(keys, func, desc, mode)
            mode = mode or 'n'
            vim.keymap.set(mode, keys, func, { buffer = event.buf, desc = 'LSP: ' .. desc })
          end

          map('grn', vim.lsp.buf.rename, '[R]e[n]ame')
          map('gra', vim.lsp.buf.code_action, '[G]oto Code [A]ction', { 'n', 'x' })
          map('grr', require('telescope.builtin').lsp_references, '[G]oto [R]eferences')
          map('gri', require('telescope.builtin').lsp_implementations, '[G]oto [I]mplementation')
          map('grd', require('telescope.builtin').lsp_definitions, '[G]oto [D]efinition')
          map('grD', vim.lsp.buf.declaration, '[G]oto [D]eclaration')
          map('gO', require('telescope.builtin').lsp_document_symbols, 'Open Document Symbols')
          map('gW', require('telescope.builtin').lsp_dynamic_workspace_symbols, 'Open Workspace Symbols')
          map('grt', require('telescope.builtin').lsp_type_definitions, '[G]oto [T]ype Definition')

          local client = vim.lsp.get_client_by_id(event.data.client_id)
          if client and client.supports_method(vim.lsp.protocol.Methods.textDocument_documentHighlight) then
            local highlight_augroup = vim.api.nvim_create_augroup('kickstart-lsp-highlight', { clear = false })
            vim.api.nvim_create_autocmd({ 'CursorHold', 'CursorHoldI' }, {
              buffer = event.buf,
              group = highlight_augroup,
              callback = vim.lsp.buf.document_highlight,
            })
            vim.api.nvim_create_autocmd({ 'CursorMoved', 'CursorMovedI' }, {
              buffer = event.buf,
              group = highlight_augroup,
              callback = vim.lsp.buf.clear_references,
            })
          end

          if client and client.supports_method(vim.lsp.protocol.Methods.textDocument_inlayHint) then
            map('<leader>th', function()
              vim.lsp.inlay_hint.enable(not vim.lsp.inlay_hint.is_enabled({ bufnr = event.buf }))
            end, '[T]oggle Inlay [H]ints')
          end
        end,
      })

      -- Capabilities –¥–ª—è completion
      local capabilities = require('blink.cmp').get_lsp_capabilities()

      -- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ lspconfig —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
      local lspconfig_ok, lspconfig = pcall(require, 'lspconfig')
      if not lspconfig_ok then
        vim.notify('nvim-lspconfig not found', vim.log.levels.ERROR)
        return
      end

      -- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ LSP —Å–µ—Ä–≤–µ—Ä–æ–≤ (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ Nix)
      local servers = {
        nil_ls = {},
        lua_ls = {
          settings = {
            Lua = {
              completion = { callSnippet = 'Replace' },
              diagnostics = { globals = { 'vim' } },
            },
          },
        },
        ts_ls = {},
        pyright = {},
        html = {},
        cssls = {},
        jsonls = {},
        bashls = {},
      }

      -- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–µ—Ä
      for server_name, config in pairs(servers) do
        if lspconfig[server_name] then
          config.capabilities = vim.tbl_deep_extend('force', {}, capabilities, config.capabilities or {})
          lspconfig[server_name].setup(config)
        end
      end
    end,
  },
}

=================== END FILE ===================
File: ./modules/home-manager/programs/development/nvim/config/lua/plugins/lsp.lua
================================================


